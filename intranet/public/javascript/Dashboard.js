function initGUI(){	hideLoadingDiv();		searchDataFromDiv1();	searchDataFromDiv2();	searchUnreadEmailBestellung();	searchExternKommentar();	searchBestellungStatus();	searchProduktWarning();}function searchProduktWarning(){	var sql =   `SELECT 					P.ProduktString2,					PE.prIDX,					PE.ProduktEinzelInt1,					mainTable.LagerInt1,					-- 只统计 Status = 2					SUM(CASE WHEN mainTable.Status = 2 THEN 1 ELSE 0 END) AS iCount,					CASE 						WHEN PE.prIDX IS NULL THEN ''						ELSE (							SELECT GROUP_CONCAT(									   CONCAT(pa.ProduktAttributeString1, '##', pa.ProduktAttributeString2)									   SEPARATOR '#-#'								   )							FROM laaver.produkt_attribute pa							WHERE FIND_IN_SET(pa.prIDX, PE.ProduktEinzelString1)						)					END AS Attribute				FROM laaver.Lager AS mainTable				INNER JOIN laaver.Vorhersage_Pos AS VP 					ON VP.prIDX = mainTable.LagerInt2				INNER JOIN laaver.Vorhersage AS V 					ON V.prIDX = VP.frIDX				INNER JOIN laaver.Produkt_Einzel AS PE 					ON PE.prIDX = mainTable.LagerInt1				INNER JOIN laaver.Produkt AS P 					ON P.prIDX = mainTable.LagerInt4				GROUP BY 					P.ProduktString2,					PE.prIDX,					PE.ProduktEinzelInt1,					mainTable.LagerInt1,					Attribute				HAVING 					iCount < PE.ProduktEinzelInt1				ORDER BY 					P.ProduktString2,					Attribute				LIMIT 10000;				`;	var sql =		$.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(sql)		},		success: function (response) {			let ResultArr = response.results;			if(ResultArr.length>0){				let quantityAlertText = "";				switch (lang) {					case "en": quantityAlertText = "Quantity Alert"; break;					case "de": quantityAlertText = "Mengenwarnung"; break;					case "fr": quantityAlertText = "Alerte de quantité"; break;					case "cn": quantityAlertText = "数量提醒"; break;				}				var txt = "<div class='col-12' style='line-height:25px;'>"+quantityAlertText+"</div>";				for(var i=0; i<ResultArr.length; i++){					let tempName = unescape(ResultArr[i].ProduktString2);					if(unescape(ResultArr[i].Attribute)!="Standard##Standard") tempName += " | " + unescape(ResultArr[i].Attribute).replace(/Standard##Standard/ig,"").replace(/##/ig,": ").replace(/#-#/ig," - ");					txt += "<div class='col-8' style='line-height:25px;'>"+tempName+"</div><div class='col-4' style='line-height:25px;'>"+ResultArr[i].iCount+"/"+ResultArr[i].ProduktEinzelInt1+"</div>";				}				txt += "<div class='col-12' style='line-height:25px;'>&nbsp;</div>";				document.getElementById("KundenBemerkungDiv").innerHTML += txt;  			}		}	});}	function exportProdukt(){	showLoadingDiv();	var today = new Date();    var year = today.getFullYear();    var month = ("0" + (today.getMonth() + 1)).slice(-2);    var day = ("0" + today.getDate()).slice(-2);    var filename = "laaver_Produkt_" + year + month + day;		var sql = "SELECT * FROM `laaver`.Produkt";	$.ajax({        type: "POST",        url: "/Export_Produkt_Excel",        contentType: 'application/x-www-form-urlencoded',        async: true,        cache: false,        data: {			"filename": filename		},        success: function (response) {            hideLoadingDiv(); // 隐藏加载动画            if (response.success) {                window.open("https://intranet.laaver.de" + response.downloadUrl);            } else {                alert("导出失败！");            }        },        error: function (xhr, status, error) {            hideLoadingDiv();            console.error("Node AJAX 请求失败: ", status, error);            alert("导出时发生错误！");        }    });  }	function searchBestellungStatus(){	$.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(				"SELECT " +				"(SELECT COUNT(*) FROM `laaver`.bestellung WHERE Status=1) AS Count1, " +				"(SELECT COUNT(*) FROM `laaver`.bestellung WHERE Status=2) AS Count2, " +				"(SELECT COUNT(*) FROM `laaver`.bestellung WHERE Status=5) AS Count3"			)		},		success: function (response) {			var result = response.results[0];			document.getElementById("BestellungSpan1").innerHTML = result.Count1;			document.getElementById("BestellungSpan2").innerHTML = result.Count2;			document.getElementById("BestellungSpan3").innerHTML = result.Count3;		}	});}	function searchUnreadEmailBestellung(){	$.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(				"SELECT " +				"(SELECT COUNT(*) FROM `laaver`.email_import WHERE EmailImportInt4=0) AS Count1, " +				"(SELECT COUNT(*) FROM (SELECT EmailImportInt3 FROM `laaver`.email_import WHERE NOT EmailImportInt3=0 AND EmailImportInt4=1 AND EmailImportInt5=0 GROUP BY EmailImportInt3) A) AS Count2, " +				"(SELECT COUNT(*) FROM `laaver`.bestellung WHERE BestellungBIT1=0) AS Count3"			)		},		success: function (response) {			var result = response.results[0];			document.getElementById("EmailImportSpan1").innerHTML = result.Count1;			//document.getElementById("EmailImportSpan2").innerHTML = result.Count2;			//document.getElementById("EmailImportSpan3").innerHTML = result.Count3;		}	});}	/**** Syn Begin ****/function SynEmailDaten(){	showLoadingDiv();	var startDate = new Date();	startDate.setDate(startDate.getDate() - 10); // 10天前	var startDateFormatted = startDate.toISOString().slice(0, 10);	var endDateFormatted = new Date().toISOString().slice(0, 10); 	// 格式化结束日期为今天		$.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(				"SELECT CASE WHEN Datum1 IS NULL THEN '' ELSE DATE_FORMAT(Datum1,'%Y-%m-%d') END AS sDatum1 " +				"FROM `laaver`.Email_Import " +				"ORDER BY prIDX DESC LIMIT 1"			)		},		success: function (response) {			if (response.results.length > 0 && response.results[0].sDatum1 !== "") {				startDateFormatted = response.results[0].sDatum1;			}			synEmailImportA(startDateFormatted, endDateFormatted);		}	});}	function synEmailImportA(startDateFormatted,endDateFormatted){	$.ajax({      type: "POST",         url: "/Email_Import_Func",         data:{			"startDateFormatted": startDateFormatted,			"endDateFormatted": endDateFormatted,		 },         cache: false,         success: function (response) {			//console.log(response);			var newEmailImportArr = new Array();			for(var i=0; i<response.length; i++){				newEmailImportArr.push(new EmailImportObj());				newEmailImportArr[newEmailImportArr.length-1].Datum1 = String(response[i].date).substring(0,19);				newEmailImportArr[newEmailImportArr.length-1].EmailImportString10 = extractEmailName(response[i].from);				newEmailImportArr[newEmailImportArr.length-1].EmailImportString11 = extractEmailName(response[i].to);				newEmailImportArr[newEmailImportArr.length-1].EmailImportString12 = escape(response[i].subject);				newEmailImportArr[newEmailImportArr.length-1].EmailImportString13 = escape(response[i].body);				newEmailImportArr[newEmailImportArr.length-1].EmailImportBIT1 = 0;				newEmailImportArr[newEmailImportArr.length-1].EmailImportInt3 = 0;				if(response[i].attachments.length>0){					newEmailImportArr[newEmailImportArr.length-1].EmailImportBIT1 = 1;				}								newEmailImportArr[newEmailImportArr.length-1].EmailImportString20 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString21 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString22 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString23 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString24 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString25 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString26 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString27 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString28 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString29 = "";				newEmailImportArr[newEmailImportArr.length-1].EmailImportString30 = "";								for(var j=0; j<response[i].attachments.length; j++){					if(j<10){						eval("newEmailImportArr[newEmailImportArr.length-1].EmailImportString"+parseInt(20+j)+"=escape(response[i].attachments[j]);");					}				}			}			//console.log(newEmailImportArr);            if(newEmailImportArr.length>0) checkBase64Code(newEmailImportArr);         },         error: function (response) {            console.log(response);         }   });}function extractEmailName(email) {    const regex = /<([^>]+)>/;    const match = email.match(regex);    if (match && match.length > 1) {        return match[1];    } else {        return email;    }}function checkBase64Code(newEmailImportArr){	for(var i=0; i<newEmailImportArr.length; i++){		var EmailImportString13 = String(newEmailImportArr[i].EmailImportString13).replace(/%0A/ig,"").replace(/%3Cbr%3E/ig,"");		if(isBase64String(EmailImportString13)) {			newEmailImportArr[i].EmailImportString13 = escape(decodeBase64(String(newEmailImportArr[i].EmailImportString13).replace(/%0A/ig,"").replace(/%3Cbr%3E/ig,"")));		}	}			//尝试将邮件拉进相应的订单(通过订单号)	var regex1 = /Bestellnummer #(\d{4,6})/;	var regex2 = /Bestellung: #(\d{4,6})/;	for(var i=0; i<newEmailImportArr.length; i++){ 		var match1 = unescape(newEmailImportArr[i].EmailImportString13).match(regex1);		var match2 = unescape(newEmailImportArr[i].EmailImportString13).match(regex2);		if (match1 && match1[1]) {			newEmailImportArr[i].EmailImportInt3 = parseInt(match1[1]);		}else if (match2 && match2[1]) {			newEmailImportArr[i].EmailImportInt3 = parseInt(match2[1]);		}	}	saveNewEmailImport(newEmailImportArr);}function saveNewEmailImport(newEmailImportArr) {   $.ajax({      type: "POST",      url: "/Email_Syn_Func",      contentType: 'application/x-www-form-urlencoded',      data: {         EmailImportTempArr: JSON.stringify(newEmailImportArr)      },      cache: false,      success: function (response) {         for (var i = 0; i < newEmailImportArr.length; i++) {            if (String(response).split("##").length > i)               newEmailImportArr[i].prIDX = parseInt(String(response).split("##")[i]);         }         if (String(response).split("##").length == newEmailImportArr.length) {            checkSystemMail(newEmailImportArr, function () {                switch (lang) {				  case 0: alert("Daten wurden geändert!"); break; // 德语				  case 1: alert("Information has been changed!"); break; // 英语				  case 2: alert("信息已更新！"); break; // 中文				  case 3: alert("Les données ont été modifiées !"); break; // 法语				}               window.location.reload();            });         } else alert("邮件同步出错！");      },      error: function (response) {         console.log(response);      }   });}function decodeBase64(base64String) {  try {    const binaryString = atob(base64String);    const byteArray = new Uint8Array(binaryString.length);    for (let i = 0; i < binaryString.length; i++) {      byteArray[i] = binaryString.charCodeAt(i);    }    const decoder = new TextDecoder('utf-8');    const decodedString = decoder.decode(byteArray);    return decodedString;  } catch (error) {    console.error('解码错误:', error);    return null;  }}function isBase64String(str) {  // 使用正则表达式检查字符串是否符合Base64编码的格式  const base64Regex = /^[A-Za-z0-9+/]+[=]{0,2}$/;  return base64Regex.test(str);}function checkSystemMail(newEmailImportArr,callback){	var bool=false;	var NewUserArr = new Array();	for(var i=0; i<newEmailImportArr.length; i++){		if(unescape(newEmailImportArr[i].EmailImportString12).indexOf("[laaver]")>=0){						if(unescape(newEmailImportArr[i].EmailImportString12).indexOf("Registrierung eines neuen Benutzers")>=0				|| unescape(newEmailImportArr[i].EmailImportString12).indexOf("Dein laaver Konto wurde erstellt")>=0				|| unescape(newEmailImportArr[i].EmailImportString12).indexOf("Konto wurde geändert")>=0){				NewUserArr.push(extractUserInfo(unescape(newEmailImportArr[i].EmailImportString13)));				NewUserArr[NewUserArr.length-1].prIDX = newEmailImportArr[i].prIDX;				NewUserArr[NewUserArr.length-1].NewUserString1 = "Benutzer";				NewUserArr[NewUserArr.length-1].NewUserString2 = "";				NewUserArr[NewUserArr.length-1].NewUserString3 = "";				NewUserArr[NewUserArr.length-1].NewUserString4 = "";				bool=true;			}else{				NewUserArr.push(extractUserInfo(unescape(newEmailImportArr[i].EmailImportString13)));				NewUserArr[NewUserArr.length-1].prIDX = newEmailImportArr[i].prIDX;				NewUserArr[NewUserArr.length-1].NewUserString1 = "Other";				NewUserArr[NewUserArr.length-1].NewUserString2 = "";				NewUserArr[NewUserArr.length-1].NewUserString3 = "";				NewUserArr[NewUserArr.length-1].NewUserString4 = "";				bool=true;			}		}	}		if(bool && NewUserArr.length>0){		let sqlStatements = [];		for (let i = 0; i < NewUserArr.length; i++) {			let user = NewUserArr[i];			if (user.NewUserString1 === "Benutzer") {				const checkSQL = "SELECT * FROM `laaver`.kunden WHERE KundenInt1=" + parseInt(user.id) + 					" OR KundenString11='" + user.email + "' LIMIT 1";				const updateSQL = "UPDATE `laaver`.kunden SET " +					"KundenString10='" + user.username + "', " +					"KundenString11='" + user.email + "', " +					"KundenString12='" + user.firstName + "', " +					"KundenString13='" + user.lastName + "', " +					"KundenString14='" + user.displayName + "', " +					"KundenInt1=" + parseInt(user.id) +					" WHERE KundenInt1=" + parseInt(user.id) + " OR KundenString11='" + user.email + "'";				const insertSQL = "INSERT INTO `laaver`.kunden " +					"(KundenString10,KundenString11,KundenString12,KundenString13,KundenString14,KundenInt1) VALUES (" +					"'" + user.username + "','" + user.email + "','" + user.firstName + "','" + user.lastName + "','" + user.displayName + "'," + parseInt(user.id) + ")";				// 使用 IF EXISTS 逻辑合并更新和插入				sqlStatements.push(					"IF EXISTS (" + checkSQL + ") THEN " + updateSQL + "; ELSE " + insertSQL + "; END IF"				);			}		}		// 合并更新 Email_Import 状态		const prIDXs = NewUserArr.map(u => u.prIDX).filter(Boolean);		if (prIDXs.length > 0) {			sqlStatements.push(				"UPDATE `laaver`.Email_Import SET Status=3 WHERE prIDX IN (" + prIDXs.join(",") + ")"			);		}		const finalSQL = sqlStatements.join("; ");		$.ajax({			type: "POST",			url: "/General_Update",			contentType: 'application/x-www-form-urlencoded',			data: {				SQL_TXT: escape(finalSQL)			},			success: function () {				synKundenDatenForEmail(newEmailImportArr, function () {					if (typeof callback === "function") callback();				});			},			error: function (response) {				console.log(response);			}		});	}else synKundenDatenForEmail(newEmailImportArr,function () { callback(); });}function extractUserInfo(inputString) {    var usernameRegex = /Benutzername: (.+)/;    var emailRegex = /E-Mail: (.+)/;    var displayNameRegex = /Anzeigename: (.+)/;    var idRegex = /ID: (.+)/;    var firstNameRegex = /Vorname: (.+)/;    var lastNameRegex = /Nachname: (.+)/;    var usernameMatch = inputString.match(usernameRegex);    var emailMatch = inputString.match(emailRegex);    var displayNameMatch = inputString.match(displayNameRegex);    var idMatch = inputString.match(idRegex);    var firstNameMatch = inputString.match(firstNameRegex);    var lastNameMatch = inputString.match(lastNameRegex);    var username = usernameMatch ? usernameMatch[1] : "";    var email = emailMatch ? emailMatch[1] : "";    var displayName = displayNameMatch ? displayNameMatch[1] : "";    var id = idMatch ? idMatch[1] : "0";    var firstName = firstNameMatch ? firstNameMatch[1] : "";    var lastName = lastNameMatch ? lastNameMatch[1] : "";    return {        username: username,        email: email,        displayName: displayName,        id: id,        firstName: firstName,        lastName: lastName    };}function synKundenDatenForEmail(newEmailImportArr, callback) {	$.ajax({		type: "POST",		url: "/Email_Syn_Func_1",		contentType: 'application/x-www-form-urlencoded',		data: {			newEmailImportArr: JSON.stringify(newEmailImportArr)		},		success: function () {			if (typeof callback === "function") callback();		},		error: function (response) {			console.log(response);		}	});}function SynKundenDatenObj(prIDX,frIDX,Name,SynKundenDatenString1,SynKundenDatenString2,SynKundenDatenString3,SynKundenDatenString4,EmailImportInt3){   this.prIDX=prIDX;   this.frIDX=frIDX;   this.Name=Name;   this.SynKundenDatenString1=SynKundenDatenString1;   this.SynKundenDatenString2=SynKundenDatenString2;   this.SynKundenDatenString3=SynKundenDatenString3;   this.SynKundenDatenString4=SynKundenDatenString4;   this.EmailImportInt3=EmailImportInt3;}function EmailImportObj(prIDX,frIDX,Datum1,Datum2,Datum3,Datum4,EmailImportString10,EmailImportString11,EmailImportString12,EmailImportString13,EmailImportInt1,EmailImportInt2,EmailImportInt3,EmailImportInt4,EmailImportFloat1,EmailImportFloat2,EmailImportFloat3,EmailImportFloat4,EmailImportBIT1,EmailImportBIT2,EmailImportString14,EmailImportString15,EmailImportString16,EmailImportString17,EmailImportString18,EmailImportString19,EmailImportString20,EmailImportString21,EmailImportString22,EmailImportString23,EmailImportString24,EmailImportString25,EmailImportString26,EmailImportString27,EmailImportString28,EmailImportString29,EmailImportInt5,Status,EmailImportFloat5,EmailImportFloat6){   this.prIDX=prIDX;   this.frIDX=frIDX;   this.Datum1=Datum1;   this.Datum2=Datum2;   this.Datum3=Datum3;   this.Datum4=Datum4;   this.EmailImportString10=EmailImportString10;   this.EmailImportString11=EmailImportString11;   this.EmailImportString12=EmailImportString12;   this.EmailImportString13=EmailImportString13;   this.EmailImportInt1=EmailImportInt1;   this.EmailImportInt2=EmailImportInt2;   this.EmailImportInt3=EmailImportInt3;   this.EmailImportInt4=EmailImportInt4;   this.EmailImportFloat1=EmailImportFloat1;   this.EmailImportFloat2=EmailImportFloat2;   this.EmailImportFloat3=EmailImportFloat3;   this.EmailImportFloat4=EmailImportFloat4;   this.EmailImportBIT1=EmailImportBIT1;   this.EmailImportBIT2=EmailImportBIT2;   this.EmailImportString14=EmailImportString14;   this.EmailImportString15=EmailImportString15;   this.EmailImportString16=EmailImportString16;   this.EmailImportString17=EmailImportString17;   this.EmailImportString18=EmailImportString18;   this.EmailImportString19=EmailImportString19;   this.EmailImportString20=EmailImportString20;   this.EmailImportString21=EmailImportString21;   this.EmailImportString22=EmailImportString22;   this.EmailImportString23=EmailImportString23;   this.EmailImportString24=EmailImportString24;   this.EmailImportString25=EmailImportString25;   this.EmailImportString26=EmailImportString26;   this.EmailImportString27=EmailImportString27;   this.EmailImportString28=EmailImportString28;   this.EmailImportString29=EmailImportString29;   this.EmailImportInt5=EmailImportInt5;   this.Status=Status;   this.EmailImportFloat5=EmailImportFloat5;   this.EmailImportFloat6=EmailImportFloat6;}/**** Syn End ****/function searchDataFromDiv1(){    let sqlList = [];	var MengeArr = [];	var DatumArr = [];	for (let i = 0; i < DatumBeginArr.length; i++) {		sqlList.push(			"SELECT '" + DatumBeginArr[i].substring(0, 7) + "' AS Monat, " +			"(SELECT COUNT(*) FROM `laaver`.Produkt WHERE " +			"DATE_FORMAT(Datum1,'%Y-%m-%d')>='" + DatumBeginArr[i] + "' AND " +			"DATE_FORMAT(Datum1,'%Y-%m-%d')<='" + DatumEndArr[i] + "') AS Menge"		);	}	$.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(sqlList.join("; "))		},		success: function (response) {			MengeArr = [];			DatumArr = [];			response.results.forEach(function (row) {				DatumArr.push(row[0].Monat);				MengeArr.push(parseInt(row[0].Menge));			});			// 可选调用处理方法			initDataFromDiv1(MengeArr, DatumArr);		},		error: function (response) {			console.log(response);		}	});}function initDataFromDiv1(MengeArr, DatumArr){	var labelColor = "#9e9e9e";	var borderColor = "#eee";	var baseColor = "#54b4d3";	var secondaryColor = "#9FA6B2";	var lightColor = "#FBFBFB";  	var txt = "";		txt +=  "var options = {"+			"series: [{"+			"name: '";	switch (lang) {	  case "en": txt += "New Products"; break;	  case "de": txt += "Neue Produkte"; break;	  case "fr": txt += "Nouveaux produits"; break;	  case "cn": txt += "新增产品"; break;	}	txt +=  "',"+			"data: [";	for(var j=0; j<MengeArr.length; j++){		if(j>0) txt += ",";		txt += parseInt(MengeArr[j]);	}				txt += "]"+			"}],"+			"chart: {"+			"fontFamily: 'inherit',"+			"type: 'area',"+			"height: 350,"+			"dropShadow: { enabled: false },"+			"toolbar: {"+			"show: true"+			"}"+			"},"+			"plotOptions: {"+			"},"+			"legend: {"+			"show: true"+			"},"+			"dataLabels: {"+			"style: { colors: [labelColor] },"+			"enabled: true"+			"},"+			"fill: {"+			"type: 'solid',"+			"opacity: 1"+			"},"+			"stroke: {"+			"curve: 'smooth',"+			"show: true,"+			"width: 3,"+			"colors: [baseColor]"+			"},"+			"xaxis: {"+			"categories: [";	for(var j=0; j<DatumArr.length; j++){		if(j>0) txt += ",";		txt += "'"+String(DatumArr[j])+"'";	}				txt += "],"+			"axisBorder: {"+			"show: false,"+			"},"+			"axisTicks: {"+			"show: false"+			"},"+			"labels: {"+			"style: {"+			"colors: labelColor,"+			"fontSize: '12px'"+			"}"+			"},"+			"crosshairs: {"+			"position: 'front',"+			"stroke: {"+			"color: baseColor,"+			"width: 1,"+			"dashArray: 3"+			"}"+			"},"+			"tooltip: {"+			"enabled: true,"+			"formatter: undefined,"+			"offsetY: 0,"+			"style: {"+			"fontSize: '12px'"+			"}"+			"}"+			"},"+			"yaxis: {"+			"labels: {"+			"style: {"+			"colors: labelColor,"+			"fontSize: '12px'"+			"}"+			"}"+			"},"+			"states: {"+			"normal: {"+			"filter: {"+			"type: 'none',"+			"value: 0"+			"}"+			"},"+			"hover: {"+			"filter: {"+			"type: 'none',"+			"value: 0"+			"}"+			"},"+			"active: {"+			"allowMultipleDataPointsSelection: false,"+			"filter: {"+			"type: 'none',"+			"value: 0"+			"}"+			"}"+			"},"+			"tooltip: {"+			"style: {"+			"fontSize: '12px'"+			"},"+			"y: {"+			"formatter: function (val) {"+			"return val + ' €'"+			"}"+			"}"+			"},"+			"colors: [lightColor],"+			"grid: {"+			"borderColor: borderColor,"+			"strokeDashArray: 4,"+			"yaxis: {"+			"lines: {"+			"show: true"+			"}"+			"}"+			"},"+			"markers: {"+			"strokeColor: baseColor,"+			"strokeWidth: 3"+			"}"+			"};";	eval(txt);	var chart = new ApexCharts(document.querySelector("#chart_1"), options);	chart.render();	}function searchDataFromDiv2(){    var Count1Arr = new Array();	var Count2Arr = new Array();	var Count3Arr = new Array();	var Count4Arr = new Array();	var DatumArr = new Array();	let sqlList = [];	for (let i = 0; i < DatumBeginArr.length; i++) {		const monat = DatumBeginArr[i].substring(0, 7);		sqlList.push(			"SELECT '" + monat + "' AS Monat, " +			"(SELECT IFNULL(SUM(BestellungFloat5),0) FROM `laaver`.Bestellung WHERE DATE_FORMAT(Datum1,'%Y-%m-%d')>='" + DatumBeginArr[i] + "' AND DATE_FORMAT(Datum1,'%Y-%m-%d')<='" + DatumEndArr[i] + "') AS Count1, " +			"(SELECT IFNULL(SUM(BestellungFloat6),0) FROM `laaver`.Bestellung WHERE DATE_FORMAT(Datum1,'%Y-%m-%d')>='" + DatumBeginArr[i] + "' AND DATE_FORMAT(Datum1,'%Y-%m-%d')<='" + DatumEndArr[i] + "') AS Count2, " +			"(SELECT IFNULL(SUM(BestellungBetragFloat2),0) FROM `laaver`.Bestellung_Betrag WHERE DATE_FORMAT(Datum1,'%Y-%m-%d')>='" + DatumBeginArr[i] + "' AND DATE_FORMAT(Datum1,'%Y-%m-%d')<='" + DatumEndArr[i] + "') AS Count3, " +			"(SELECT IFNULL(SUM(ReklamationFloat5),0) FROM `laaver`.Reklamation WHERE DATE_FORMAT(Datum1,'%Y-%m-%d')>='" + DatumBeginArr[i] + "' AND DATE_FORMAT(Datum1,'%Y-%m-%d')<='" + DatumEndArr[i] + "') AS Count4"		);	}	$.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(sqlList.join("; "))		},		success: function (response) {			Count1Arr = [];			Count2Arr = [];			Count3Arr = [];			Count4Arr = [];			DatumArr = [];			response.results.forEach(function (row) { 				DatumArr.push(row[0].Monat);				Count1Arr.push(parseInt(row[0].Count1));				Count2Arr.push(parseInt(row[0].Count2));				Count3Arr.push(parseInt(row[0].Count3));				Count4Arr.push(parseInt(row[0].Count4));			});			initDataFromDiv2(DatumArr, Count1Arr, Count2Arr, Count3Arr, Count4Arr);		},		error: function (response) {			console.log(response);		}	});}function initDataFromDiv2(DatumArr, Count1Arr, Count2Arr, Count3Arr, Count4Arr){	var labelColor = "#333";	var borderColor = "#eee";		var baseColor = "#28a745"; // 销售额为绿色    var secondaryColor = "#ffc107"; // 手续费为黄色    var lightColor = "#dc3545"; // 退货率为红色    var grayColor = "#6c757d"; // 成本为灰色		var name4 = "退货额", name3 = "手续费", name2 = "购买成本", name1 = "销售额";		switch (lang) {	  case "en":		var name4 = "Return Amount", name3 = "Handling Fee", name2 = "Purchase Cost", name1 = "Sales";		break;	  case "de":		var name4 = "Rückerstattungsbetrag", name3 = "Bearbeitungsgebühr", name2 = "Einkaufskosten", name1 = "Umsatz";		break;	  case "fr":		var name4 = "Montant des retours", name3 = "Frais de traitement", name2 = "Coût d'achat", name1 = "Ventes";		break;	  case "cn":		var name4 = "退货额", name3 = "手续费", name2 = "购买成本", name1 = "销售额";		break;	}    var options = {        series: [            {                name: name4,                data: Count4Arr            },            {                name: name3,                data: Count3Arr            },            {                name: name2,                data: Count2Arr            },            {                name: name1,                data: Count1Arr            }        ],        chart: {            fontFamily: 'inherit',            type: 'bar',            height: 350,            stacked: true,            dropShadow: { enabled: false },            toolbar: { show: true }        },        plotOptions: {            bar: {                horizontal: false,                columnWidth: '55%',                endingShape: 'flat'  // 修改顶部形状为长方形            }        },        legend: { show: true },        dataLabels: {            enabled: true,            formatter: function (val, opts) {                if (opts.seriesIndex === 3) {                    return Count1Arr[opts.dataPointIndex] + ' €';                }                return val + ' €';            },            style: { colors: [labelColor] }        },        fill: {            type: 'solid',            opacity: 1        },        stroke: {            show: true,            width: 2,            colors: ['transparent']        },        xaxis: {            categories: DatumArr,            axisBorder: { show: false },            axisTicks: { show: false },            labels: {                style: {                    colors: labelColor,                    fontSize: '12px'                }            },            crosshairs: {                position: 'front',                stroke: {                    color: baseColor,                    width: 1,                    dashArray: 3                }            },            tooltip: { enabled: true }        },        yaxis: {            labels: {                style: {                    colors: labelColor,                    fontSize: '12px'                }            }        },        tooltip: {            style: {                fontSize: '12px'            },            y: {                formatter: function (val) {                    return val + ' €';                }            }        },        colors: [lightColor, secondaryColor, grayColor, baseColor],        grid: {            borderColor: borderColor,            strokeDashArray: 4,            yaxis: { lines: { show: true } }        },        markers: {            strokeColor: baseColor,            strokeWidth: 3        }    };		var chart = new ApexCharts(document.querySelector("#chart_2"), options);	chart.render();}var DatumSource = getLastYearMonthArray();var DatumBeginArr = new Array(),DatumEndArr = new Array();for(var i=0; i<DatumSource.length; i++){	DatumEndArr.push(getLastDay(DatumSource[i].split("-")[0],DatumSource[i].split("-")[1]));	DatumBeginArr.push(DatumSource[i]+"-01");}for(var i=0; i<DatumSource.length; i++){	DatumEndArr[i] = DatumSource[i]+"-"+DatumEndArr[i];}function getLastYearMonthArray() {    var result = [];    var d = new Date();    var year = d.getFullYear();    d.setMonth(d.getMonth() + 1, 1);    for (var i = 0; i < 12; i++) {        d.setMonth(d.getMonth() - 1);        var m = d.getMonth() + 1;        m = m < 10 ? "0" + m : m;        result.push(d.getFullYear() + "-" + m);    }    return result.reverse();}function getLastDay(year, month) {    const isLeapYear = ((year % 4)==0) && ((year % 100)!=0) || ((year % 400)==0)    const maxDays = [1,3,5,7,8,10,12]      const middleDays = [4,6,9,11]      month = Number(month)    if (month == 2) {        if (isLeapYear) {            return 29        } else {            return 28        }    }  else  if (maxDays.includes(month)) {        return 31    } else if (middleDays.includes(month)) {        return 30    }}var KommentarExternArr = new Array();var ReklamationArr = new Array();function searchExternKommentar(){    $.ajax({		type: "POST",		url: "/General_Select",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(				"SELECT 'Extern' AS Typ, frIDX, NULL AS prIDX, DATE_FORMAT(MAX(Datum), '%m-%d %H:%i') AS sDatum " +				"FROM laaver.bestellung_kommentar_extern WHERE Mitarbeiter IS NULL AND bRead = 0 GROUP BY frIDX " +				"UNION ALL " +				"SELECT 'Reklamation' AS Typ, NULL AS frIDX, prIDX, DATE_FORMAT(Datum1, '%m-%d %H:%i') AS sDatum " +				"FROM laaver.bestellung WHERE Status = 5 ORDER BY sDatum"			)		},		success: function (response) {			const resultArr = response.results;			KommentarExternArr = [];			ReklamationArr = [];			for (let i = 0; i < resultArr.length; i++) {				const item = resultArr[i];				const obj = {					prIDX: item.prIDX ? parseInt(item.prIDX) : 0,					frIDX: item.frIDX ? parseInt(item.frIDX) : 0,					Datum: item.sDatum || "",					Bemerkung: "",					Mitarbeiter: ""				};				if (item.Typ === "Extern") {					KommentarExternArr.push(obj);				} else if (item.Typ === "Reklamation") {					ReklamationArr.push(obj);				}			}			showExternKommentar();		},		error: function (response) {			console.log(response);		}	});}function showExternKommentar(){	var txt="";	var msg_comment = "", msg_afterorder = "";	switch (lang) {	  case "en":		msg_comment = "Customer Comment - ";		msg_afterorder = "After-Sales Order - ";		break;	  case "de":		msg_comment = "Kundenkommentar - ";		msg_afterorder = "Nachbestellung - ";		break;	  case "fr":		msg_comment = "Commentaire client - ";		msg_afterorder = "Commande SAV - ";		break;	  case "cn":		msg_comment = "客户留言 - ";		msg_afterorder = "售后订单 - ";		break;	}	for (var i = 0; i < KommentarExternArr.length; i++) {	  txt += "<div class='col-6' style='line-height:25px;'>" + msg_comment + KommentarExternArr[i].Datum + "</div>" +			 "<div class='col-6' style='line-height:25px;'><a href='javascript:saveKommentarExternRead(" + KommentarExternArr[i].frIDX + ")'>" +			 "B" + (parseInt(KommentarExternArr[i].frIDX) + 10000) + "</a></div>";	}	for (var i = 0; i < ReklamationArr.length; i++) {	  txt += "<div class='col-6' style='line-height:25px;'>" + msg_afterorder + ReklamationArr[i].Datum + "</div>" +			 "<div class='col-6' style='line-height:25px;'><a href='/BestellungVerwalten?prIDX=" + ReklamationArr[i].prIDX + "'>" +			 "B" + (parseInt(ReklamationArr[i].prIDX) + 10000) + "</a></div>";	}	txt += "<div class='col-12' style='line-height:25px;'>&nbsp;</div>";	document.getElementById("KundenBemerkungDiv").innerHTML += txt;  }function saveKommentarExternRead(frIDX){   $.ajax({		type: "POST",		url: "/General_Update",		contentType: 'application/x-www-form-urlencoded',		data: {			SQL_TXT: escape(				"UPDATE `laaver`.bestellung_kommentar_extern SET bRead=1 " +				"WHERE Mitarbeiter IS NULL AND frIDX=" + frIDX			)		},		success: function () {			window.location.href = "/BestellungVerwalten?prIDX=" + frIDX;		},		error: function (response) {			console.log(response);		}	});}