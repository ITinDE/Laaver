const express = require('express');const cookieParser = require('cookie-parser');const upload = require('express-fileupload');const request = require('request');const async = require('async');const bodyParser = require('body-parser');const validate = require('validate-vat');const pdf = require("pdf-creator-node");const fs = require('fs');const path = require('path');const sharp = require('sharp');const https = require('https');const querystring = require('querystring');const fetch = require('node-fetch');const schedule = require('node-schedule');const Imap = require('node-imap');const { simpleParser } = require('mailparser');const app = express();app.set('views', __dirname);app.engine('html', require('ejs').renderFile);app.set('view engine', 'ejs');app.use(express.static('public'));app.use('/css', express.static(__dirname + 'css'));app.use('/js', express.static(__dirname + 'js'));app.use('/img', express.static(__dirname + 'img'));app.use(express.urlencoded({ extended: true }));// 修改最大请求体大小限制app.use(express.json({ limit: '100mb' }));app.use(express.urlencoded({ extended: true, limit: '100mb' }));app.use(upload({ limits: { fileSize: 100 * 1024 * 1024 },}));// create application/json parserconst jsonParser = bodyParser.json();// create application/x-www-form-urlencoded parserconst urlencodedParser = bodyParser.urlencoded({ extended: false });// 设置静态目录：让浏览器能通过静态目录来访问文件app.use('/optimized_images', express.static(path.join(__dirname, 'optimized_images')));app.use('/images', express.static(path.join(__dirname, 'images')));app.use('/file', express.static(path.join(__dirname, 'file')));/**** Cookies Begin ****/app.use(cookieParser());app.get('/setcookieLang', function(req, res){    res.cookie('lang', req.query.lang, { maxAge: 1000*60*60*24*30, httpOnly: false });    res.end();});/**** Cookies End ****//**** Mail Daten Begin ****/const nodemailer = require('nodemailer');const mailFrom = "laaver <info@laaver.com>";const smtpConfig = {  host: 'laaver.com',  port: 465,  secure: true,  auth: {	user: 'info@laaver.com',	pass: '4&4#TqPq0vweMgyd'  }};const imap = new Imap({		user: 'info@laaver.com',	password: '4&4#TqPq0vweMgyd',	host: 'www.laaver.com',	port: 993,	tls: true});/**** Mail Daten End ****//**** mySQL Begin ****/const mysql = require('mysql');const con = mysql.createConnection({  host: "www.laaver.com",  user: "laaver",  password: "4&4#TqPq0vweMgyd",  multipleStatements: true});con.connect(function(err) {if (err) throw err;});/**** mySQL End ****//**** 邮件自动同步 Begin ****/// 定义每小时执行一次的规则//更新邮件var lastExportTime = null; const ruleA = new schedule.RecurrenceRule();ruleA.minute = 0; // 每小时的开始时刻const jobA = schedule.scheduleJob(ruleA, function(){    const currentTime = new Date();    if (!lastExportTime || currentTime.getHours() !== lastExportTime.getHours()) {				setTimeout(function(){SynEmailDaten();},100);        lastExportTime = currentTime;    }});async function SynEmailDaten() {  // 计算日期  const startDate = new Date();  startDate.setDate(startDate.getDate() - 10); // 10天前  let startDateFormatted = startDate.toISOString().slice(0, 10);  let endDateFormatted = new Date().toISOString().slice(0, 10); // 格式化结束日期为今天  // 从数据库查询最后一次同步的日期  con.query("SELECT CASE WHEN Datum1 IS NULL THEN '' ELSE DATE_FORMAT(Datum1,'%Y-%m-%d') END AS sDatum1 FROM `laaver`.Email_Import ORDER BY prIDX DESC LIMIT 1", function (err, result) {    if (err) throw err;    // 如果数据库中有记录，使用数据库中的最后同步日期    if (result.length > 0 && result[0].sDatum1 !== '') {      startDateFormatted = result[0].sDatum1;    }	Email_Import_Func(startDateFormatted,endDateFormatted,0,0);  });}/**** 邮件自动同步 End ****//**** Website Intranet Begin ****/app.get('/', function (req, res){    res.render('Dashboard.ejs', { lang: req.cookies['lang'] });});app.get('/Dashboard', function (req, res){    res.render('Dashboard.ejs', { lang: req.cookies['lang'] });});app.get('/Login', function (req, res){    res.render('Login.ejs', { lang: req.cookies['lang'] });});app.get('/Mitarbeiter', function (req, res){    res.render('Mitarbeiter.ejs', { lang: req.cookies['lang'] });});app.get('/Kunden', function (req, res){    res.render('Kunden.ejs', { lang: req.cookies['lang'] });});app.get('/HomepageEdit', function (req, res){    res.render('HomepageEdit.ejs', { lang: req.cookies['lang'] });});app.get('/ProduktVerwalten', function (req, res){    res.render('ProduktVerwalten.ejs', { lang: req.cookies['lang'] });});app.get('/ProduktKatalog', function (req, res){    res.render('ProduktKatalog.ejs', { lang: req.cookies['lang'] });});app.get('/ProduktEigenschaft', function (req, res){    res.render('ProduktEigenschaft.ejs', { lang: req.cookies['lang'] });});app.get('/ProduktHersteller', function (req, res){    res.render('ProduktHersteller.ejs', { lang: req.cookies['lang'] });});app.get('/EmailImport', function (req, res){    res.render('EmailImport.ejs', { lang: req.cookies['lang'] });});app.get('/BestellungVerwalten', function (req, res){    res.render('BestellungVerwalten.ejs', { lang: req.cookies['lang'] });});app.get('/News', function (req, res){    res.render('News.ejs', { lang: req.cookies['lang'] });});app.get('/Vorhersage', function (req, res){    res.render('Vorhersage.ejs', { lang: req.cookies['lang'] });});app.get('/WarenSendung', function (req, res){    res.render('WarenSendung.ejs', { lang: req.cookies['lang'] });});app.get('/Lagerinfo', function (req, res){    res.render('Lagerinfo.ejs', { lang: req.cookies['lang'] });});app.get('/Overview', function (req, res){    res.render('Overview.ejs', { lang: req.cookies['lang'] });});app.get('/AngebotVerwalten', function (req, res){    res.render('AngebotVerwalten.ejs', { lang: req.cookies['lang'] });});app.get('/Vertreter', function (req, res){    res.render('Vertreter.ejs', { lang: req.cookies['lang'] });});app.get('/Vertreter_Bestell', function (req, res){    res.render('Vertreter_Bestell.ejs', { lang: req.cookies['lang'] });});/**** Website Intranet End ****//**** FileUpload Begin****/app.post('/file-upload', function(req, res) {  let sampleFile;  let uploadPath;  if (!req.files || Object.keys(req.files).length === 0) {    return res.status(400).send('No files were uploaded.');  }  sampleFile = req.files.sampleFile;  uploadPath = __dirname + '/public/file/'+req.body.ordnername+'/'+req.body.filename;  var url = String("https://intranet.laaver.com/BestellungVerwalten?prIDX="+req.body.prIDX);    sampleFile.mv(uploadPath, function(err) {    if (err) return res.status(500).send(err);		res.redirect(url);  });});app.post('/file-insert-news', function(req, res) {    const files = req.files;    const uploadedFiles = [];    if (!files || (Array.isArray(files) && files.length === 0) || (typeof files === 'object' && Object.keys(files).length === 0)) {        return res.status(400).send('No files were uploaded.');    }    const filesArray = Array.isArray(Object.values(files)[0]) ? Object.values(files)[0] : Object.values(files);    const fileUploadPromises = filesArray.map(file => {        const uploadPath = path.join(__dirname, 'public', 'file', 'news', file.name);        return new Promise((resolve, reject) => {            file.mv(uploadPath, function(err) {                if (err) {                    reject(err);                } else {                    uploadedFiles.push(file.name);                    resolve();                }            });        });    });    Promise.all(fileUploadPromises)        .then(() => {            // 返回上传成功的文件名            res.send(uploadedFiles);        })        .catch(err => {            res.status(500).send(err);        });});app.post('/file-upload-pdf', function(req, res) {    const files = req.files;    const uploadedFiles = [];    if (!files || (Array.isArray(files) && files.length === 0) || (typeof files === 'object' && Object.keys(files).length === 0)) {        return res.status(400).send('No files were uploaded.');    }    const filesArray = Array.isArray(Object.values(files)[0]) ? Object.values(files)[0] : Object.values(files);    const fileUploadPromises = filesArray.map(file => {        const uploadPath = path.join(__dirname, 'public', 'file', 'pdf', file.name);        return new Promise((resolve, reject) => {            file.mv(uploadPath, function(err) {                if (err) {                    reject(err);                } else {                    uploadedFiles.push(file.name);                    resolve();                }            });        });    });    Promise.all(fileUploadPromises)        .then(() => {            // 返回上传成功的文件名            res.send(uploadedFiles);        })        .catch(err => {            res.status(500).send(err);        });});app.post('/file-upload-produkt', function(req, res) {    const files = req.files;    const uploadedFiles = [];    if (!files || (Array.isArray(files) && files.length === 0) || (typeof files === 'object' && Object.keys(files).length === 0)) {        return res.status(400).send('No files were uploaded.');    }    const filesArray = Array.isArray(Object.values(files)[0]) ? Object.values(files)[0] : Object.values(files);    const fileUploadPromises = filesArray.map(file => {        const uploadPath = path.join(__dirname, 'public', 'file', 'product', file.name);        return new Promise((resolve, reject) => {            file.mv(uploadPath, function(err) {                if (err) {                    reject(err);                } else {                    uploadedFiles.push(file.name);                    resolve();                }            });        });    });    Promise.all(fileUploadPromises)        .then(() => {            // 返回上传成功的文件名            res.send(uploadedFiles);        })        .catch(err => {            res.status(500).send(err);        });});app.post('/file-upload-vorhersage', function(req, res) {  let sampleFile;  let uploadPath;  if (!req.files || Object.keys(req.files).length === 0) {    return res.status(400).send('No files were uploaded.');  }  sampleFile = req.files.sampleFile;  uploadPath = __dirname + '/public/file/'+req.body.ordnername+'/'+req.body.filename;    sampleFile.mv(uploadPath, function(err) {    if (err) return res.status(500).send(err);		res.end();  });});app.post('/file-upload-one', function(req, res) {    const files = req.files;    const uploadedFiles = [];    if (!files || (Array.isArray(files) && files.length === 0) || (typeof files === 'object' && Object.keys(files).length === 0)) {        return res.status(400).send('No files were uploaded.');    }    const filesArray = Array.isArray(Object.values(files)[0]) ? Object.values(files)[0] : Object.values(files);    const fileUploadPromises = filesArray.map(file => {        const uploadPath = path.join(__dirname, 'public', 'file', 'product', file.name);        return new Promise((resolve, reject) => {            file.mv(uploadPath, function(err) {                if (err) {                    reject(err);                } else {                    uploadedFiles.push(file.name);                    resolve();                }            });        });    });    Promise.all(fileUploadPromises)        .then(() => {            // 返回上传成功的文件名            res.send(uploadedFiles);        })        .catch(err => {            res.status(500).send(err);        });});app.post('/file-upload-multiple', function(req, res) {    const files = req.files;    const uploadedFiles = [];    if (!files || (Array.isArray(files) && files.length === 0) || (typeof files === 'object' && Object.keys(files).length === 0)) {        return res.status(400).send('No files were uploaded.');    }    const filesArray = Array.isArray(Object.values(files)[0]) ? Object.values(files)[0] : Object.values(files);    const fileUploadPromises = filesArray.map(file => {        const uploadPath = path.join(imageDirectory, file.name);        return new Promise((resolve, reject) => {            file.mv(uploadPath, function(err) {                if (err) {                    reject(err);                } else {                    uploadedFiles.push(file.name);                    resolve();                }            });        });    });    Promise.all(fileUploadPromises)        .then(() => convertAndOptimizeImages(uploadedFiles))        .then(convertedFiles => {            res.json(convertedFiles);        })        .catch(err => {            res.status(500).send(err);        });});const imageDirectory = path.join(__dirname, 'public', 'file', 'upload');const optimizeOutputDirectory = path.join(__dirname, 'public', 'optimized_images');const sizes = [480, 720, 1080, 1920];async function convertAndOptimizeImages(uploadedFiles) {    const convertedFiles = [];    const convertAndOptimize = async (filename) => {        const inputPath = path.join(imageDirectory, filename);        const webpFilename = path.basename(filename, path.extname(filename)) + '.webp';        const webpPath = path.join(imageDirectory, webpFilename);        // Convert to WebP        if (path.extname(filename).toLowerCase() !== '.webp') {            await sharp(inputPath)                .webp({ quality: 100 })                .toFile(webpPath);            convertedFiles.push(webpFilename);        } else {            convertedFiles.push(filename);        }        // Optimize the WebP file        const filePath = path.join(imageDirectory, webpFilename);        sizes.forEach(size => {            const outputFilePath = path.join(optimizeOutputDirectory, `${path.parse(webpFilename).name}-${size}w.webp`);            sharp(filePath)                .resize(size)                .toFile(outputFilePath, (err, info) => {                    if (err) {                        console.error(`Error resizing ${webpFilename} to ${size}w:`, err);                    } else {                        //console.log(`Successfully resized ${webpFilename} to ${size}w:`, info);                    }                });        });    };    const promises = uploadedFiles.map(filename => convertAndOptimize(filename));    return Promise.all(promises)        .then(() => convertedFiles)        .catch(error => {            console.error('Error converting and optimizing images:', error);            throw error;        });}app.post('/download-import-produkt-foto', function (req, res) {  const arr = req.body.ProduktImportNodeArr;  console.log("收到图片列表：", arr.length);  if (!Array.isArray(arr) || arr.length === 0) {    return res.status(400).json({ message: '无有效图片数据' });  }  const validItems = arr.filter(item =>    typeof item.ProduktString10 === 'string' &&    item.ProduktString13  );  if (validItems.length === 0) {    return res.status(400).json({ message: '过滤后无有效图片链接' });  }  const downloadPromises = validItems.map(item => {    return new Promise((resolve, reject) => {      const decodedUrl = decodeURIComponent(item.ProduktString10);      console.log("准备下载：", decodedUrl);      fetch(decodedUrl)        .then(response => {          const contentType = response.headers.get('content-type') || "";          if (!response.ok) {            return reject(`请求失败 ${response.status}: ${decodedUrl}`);          }          if (!contentType.startsWith('image/')) {            return reject(`内容类型非图片：${decodedUrl}，Content-Type: ${contentType}`);          }          return response.buffer();        })        .then(buffer => {          const savePath = path.join(__dirname, 'public', 'file', 'product', item.ProduktString13);          fs.writeFile(savePath, buffer, err => {            if (err) {              return reject(`保存失败 ${item.ProduktString13}: ${err.message}`);            }            console.log("保存成功：", item.ProduktString13);            resolve(item.ProduktString13);          });        })        .catch(err => {          reject(`下载出错：${decodedUrl} -> ${err.message}`);        });    });  });  Promise.allSettled(downloadPromises)    .then(results => {      const successFiles = results.filter(r => r.status === 'fulfilled').map(r => r.value);      const failedInfo = results.filter(r => r.status === 'rejected').map(r => r.reason);      console.log("下载成功文件数：", successFiles.length);      if (failedInfo.length > 0) {        console.warn("下载失败列表：", failedInfo);      }      res.json({        success: true,        downloaded: successFiles,        failed: failedInfo      });    })    .catch(err => {      console.error("严重错误：", err);      res.status(500).json({ error: '下载失败', details: err.message });    });});/**** FileUpload End****//**** JSON Export Begin****/app.post('/JSON_Export', urlencodedParser, function (req, res, next) {    const filename = unescape(req.body.filename);    const JSON_File = __dirname + "/public/json/" + filename + ".json";    const JSON_Data = JSON.parse(req.body.ProduktArr);		const jsonString = JSON.stringify(JSON_Data, null, 2);	// 将字符串写入文件	fsa.writeFile(JSON_File, jsonString, (err) => {	  if (err) {		console.error('写入文件时出错:', err);		res.status(500).send('写入文件时出错');	  } else {		res.status(200).send('JSON文件已成功导出');	  }	});	});/**** JSON Export End****//**** Homepage Update Begin****/app.post('/Update_Homepage', urlencodedParser, async function (req, res, next) {   const postData = querystring.stringify({    key1: String(req.body.HomepageEditString2),    key2: String(req.body.HomepageEditString8)  });  const options = {    hostname: 'laaver.com',    port: 443,    path: '/Frontend_Update_Homepage',    method: 'POST',    headers: {      'Content-Type': 'application/x-www-form-urlencoded',      'Content-Length': Buffer.byteLength(postData)    }  };  const externalReq = https.request(options, (externalRes) => {    externalRes.resume(); // 忽略响应内容，防止内存泄漏  });  externalReq.on('error', (e) => {    console.error('请求出错:', e);  });  externalReq.write(postData);  externalReq.end();  res.end();});/**** Homepage Update End****//**** Excel Export Begin****/const xl = require('excel4node');const mime = require('mime');app.post('/Excel_Export', urlencodedParser, function (req, res, next){	var filename = unescape(req.body.filename);	var ExcelFile = __dirname + "/excel/" + filename + ".xlsx";	var ExcelHeaderColumns = JSON.parse(req.body.ExcelHeaderColumns);	var ExcelData = JSON.parse(req.body.ExcelData);		const wb = new xl.Workbook();	const ws = wb.addWorksheet('DHL Daten');		let colIndex = 1;	ExcelHeaderColumns.forEach((item) => {		ws.cell(1,colIndex++).string(unescape(item));	});		let rowIndex = 2;	ExcelData.forEach((item) => {		let columnIndex = 1;		Object.keys(item).forEach((colName) => {			ws.cell(rowIndex,columnIndex++).string(unescape(item[colName]));		});		rowIndex++;	});		var myStyle = wb.createStyle({	  font: {		bold: true,	  },	  alignment: {		wrapText: false,		horizontal: 'center',	  },	  border: {		bottom: {			style: "medium",            color: "black",        },	  },	});		ws.cell(1, 1, 1, parseInt(ExcelHeaderColumns.length)).style(myStyle);	ws.row(1).setHeight(20);		wb.write(__dirname + "/public/excel/datei/" + filename + ".xlsx");		res.end();});app.post('/Export_Produkt_Excel', urlencodedParser, function (req, res, next){  const filename = unescape(req.body.filename);    const showProduktAttributArr = [									{ Attribut: "prIDX",lang: ["Serial Number","Seriennummer","Numéro de série","序列号"] },									{ Attribut: "frIDX",lang: ["Supplier", "Lieferant", "Fournisseur", "供货商"] },									{ Attribut: "Datum1",lang: ["Creation Date","Erstellungsdatum","Date de création","创建日期"] },									{ Attribut: "Datum2",lang: ["Modification Date", "Änderungsdatum", "Date de modification", "更改日期"] },									{ Attribut: "Datum3",lang: ["Datum3","Datum3","Datum3","Datum3"] },									{ Attribut: "Datum4",lang: ["Datum4","Datum4","Datum4","Datum4"] },									{ Attribut: "Status",lang: ["Status","Status","Statut","状态"] },									{ Attribut: "ProduktString1",lang: ["SKU","SKU","SKU","SKU"] },									{ Attribut: "ProduktString2",lang: ["German Name", "Deutscher Name", "Nom allemand", "德文名"] },									{ Attribut: "ProduktString3",lang: ["Chinese Name", "Chinesischer Name", "Nom chinois", "中文名"] },									{ Attribut: "ProduktString4",lang: ["English Name", "Englischer Name", "Nom anglais", "英文名"] },									{ Attribut: "ProduktString5",lang: ["French Name", "Französischer Name", "Nom français", "法文名"] },									{ Attribut: "ProduktString6",lang: ["Product Sheet", "Produktblatt", "Fiche produit", "产品表格"] },									{ Attribut: "ProduktString7",lang: ["Text Description", "Textbeschreibung", "Description textuelle", "文字描述"] },									{ Attribut: "ProduktString8",lang: ["Internal Note", "Interne Notiz", "Note interne", "内部备注"] },									{ Attribut: "ProduktString9",lang: ["ProduktString9","ProduktString9","ProduktString9","ProduktString9"] },									{ Attribut: "ProduktString10",lang: ["Image cache", "Bildcache", "Cache d'images", "图片缓存"] },									{ Attribut: "ProduktString11",lang: ["Amazon Link", "Amazon-Link", "Lien Amazon", "亚马逊链接"] },									{ Attribut: "ProduktString12",lang: ["Internal Code", "Interne Nummer", "Code interne", "内部编号"] },									{ Attribut: "ProduktString13",lang: ["Cover Image", "Titelbild", "Image de couverture", "封面图"] },									{ Attribut: "ProduktString14",lang: ["Product Tags", "Produkt-Tags", "Étiquettes de produit", "产品标签"] },									{ Attribut: "ProduktString15",lang: ["ProduktString15","ProduktString15","ProduktString15","ProduktString15"] },									{ Attribut: "ProduktString16",lang: ["ProduktString16","ProduktString16","ProduktString16","ProduktString16"] },									{ Attribut: "ProduktString17",lang: ["ProduktString17","ProduktString17","ProduktString17","ProduktString17"] },									{ Attribut: "ProduktString18",lang: ["ProduktString18","ProduktString18","ProduktString18","ProduktString18"] },									{ Attribut: "ProduktString19",lang: ["ProduktString19","ProduktString19","ProduktString19","ProduktString19"] },									{ Attribut: "ProduktString20",lang: ["ProduktString20","ProduktString20","ProduktString20","ProduktString20"] },									{ Attribut: "ProduktString21",lang: ["ProduktString21","ProduktString21","ProduktString21","ProduktString21"] },									{ Attribut: "ProduktString22",lang: ["ProduktString22","ProduktString22","ProduktString22","ProduktString22"] },									{ Attribut: "ProduktString23",lang: ["ProduktString23","ProduktString23","ProduktString23","ProduktString23"] },									{ Attribut: "ProduktString24",lang: ["ProduktString24","ProduktString24","ProduktString24","ProduktString24"] },									{ Attribut: "ProduktString25",lang: ["ProduktString25","ProduktString25","ProduktString25","ProduktString25"] },									{ Attribut: "ProduktString26",lang: ["ProduktString26","ProduktString26","ProduktString26","ProduktString26"] },									{ Attribut: "ProduktString27",lang: ["ProduktString27","ProduktString27","ProduktString27","ProduktString27"] },									{ Attribut: "ProduktString28",lang: ["ProduktString28","ProduktString28","ProduktString28","ProduktString28"] },									{ Attribut: "ProduktString29",lang: ["ProduktString29","ProduktString29","ProduktString29","ProduktString29"] },									{ Attribut: "ProduktString30",lang: ["ProduktString30","ProduktString30","ProduktString30","ProduktString30"] },									{ Attribut: "ProduktString31",lang: ["ProduktString31","ProduktString31","ProduktString31","ProduktString31"] },									{ Attribut: "ProduktString32",lang: ["ProduktString32","ProduktString32","ProduktString32","ProduktString32"] },									{ Attribut: "ProduktString33",lang: ["ProduktString33","ProduktString33","ProduktString33","ProduktString33"] },									{ Attribut: "ProduktString34",lang: ["ProduktString34","ProduktString34","ProduktString34","ProduktString34"] },									{ Attribut: "ProduktString35",lang: ["ProduktString35","ProduktString35","ProduktString35","ProduktString35"] },									{ Attribut: "ProduktString36",lang: ["ProduktString36","ProduktString36","ProduktString36","ProduktString36"] },									{ Attribut: "ProduktString37",lang: ["ProduktString37","ProduktString37","ProduktString37","ProduktString37"] },									{ Attribut: "ProduktString38",lang: ["ProduktString38","ProduktString38","ProduktString38","ProduktString38"] },									{ Attribut: "ProduktString39",lang: ["ProduktString39","ProduktString39","ProduktString39","ProduktString39"] },									{ Attribut: "ProduktString40",lang: ["ProduktString40","ProduktString40","ProduktString40","ProduktString40"] },									{ Attribut: "ProduktString41",lang: ["ProduktString41","ProduktString41","ProduktString41","ProduktString41"] },									{ Attribut: "ProduktString42",lang: ["ProduktString42","ProduktString42","ProduktString42","ProduktString42"] },									{ Attribut: "ProduktString43",lang: ["ProduktString43","ProduktString43","ProduktString43","ProduktString43"] },									{ Attribut: "ProduktString44",lang: ["ProduktString44","ProduktString44","ProduktString44","ProduktString44"] },									{ Attribut: "ProduktString45",lang: ["ProduktString45","ProduktString45","ProduktString45","ProduktString45"] },									{ Attribut: "ProduktString46",lang: ["ProduktString46","ProduktString46","ProduktString46","ProduktString46"] },									{ Attribut: "ProduktString47",lang: ["ProduktString47","ProduktString47","ProduktString47","ProduktString47"] },									{ Attribut: "ProduktString48",lang: ["ProduktString48","ProduktString48","ProduktString48","ProduktString48"] },									{ Attribut: "ProduktString49",lang: ["ProduktString49","ProduktString49","ProduktString49","ProduktString49"] },									{ Attribut: "ProduktString50",lang: ["ProduktString50","ProduktString50","ProduktString50","ProduktString50"] },									{ Attribut: "ProduktInt1",lang: ["Product Type", "Produkttyp", "Type de produit", "产品类型"] },									{ Attribut: "ProduktInt2",lang: ["Product Attribute", "Produkteigenschaft", "Attribut du produit", "产品属性"] },									{ Attribut: "ProduktInt3",lang: ["Manufacturer", "Hersteller", "Fabricant", "生产厂家"] },									{ Attribut: "ProduktInt4",lang: ["Delivery Time", "Lieferzeit", "Délai de livraison", "送货时长"] },									{ Attribut: "ProduktInt5",lang: ["Employee", "Mitarbeiter", "Employé", "员工"] },									{ Attribut: "ProduktInt6",lang: ["ProduktInt6","ProduktInt6","ProduktInt6","ProduktInt6"] },									{ Attribut: "ProduktInt7",lang: ["ProduktInt7","ProduktInt7","ProduktInt7","ProduktInt7"] },									{ Attribut: "ProduktInt8",lang: ["ProduktInt8","ProduktInt8","ProduktInt8","ProduktInt8"] },									{ Attribut: "ProduktInt9",lang: ["ProduktInt9","ProduktInt9","ProduktInt9","ProduktInt9"] },									{ Attribut: "ProduktInt10",lang: ["Discount", "Rabatt", "Remise", "折扣"] },									{ Attribut: "ProduktInt11",lang: ["ProduktInt11","ProduktInt11","ProduktInt11","ProduktInt11"] },									{ Attribut: "ProduktInt12",lang: ["ProduktInt12","ProduktInt12","ProduktInt12","ProduktInt12"] },									{ Attribut: "ProduktInt13",lang: ["ProduktInt13","ProduktInt13","ProduktInt13","ProduktInt13"] },									{ Attribut: "ProduktInt14",lang: ["ProduktInt14","ProduktInt14","ProduktInt14","ProduktInt14"] },									{ Attribut: "ProduktInt15",lang: ["ProduktInt15","ProduktInt15","ProduktInt15","ProduktInt15"] },									{ Attribut: "ProduktInt16",lang: ["ProduktInt16","ProduktInt16","ProduktInt16","ProduktInt16"] },									{ Attribut: "ProduktInt17",lang: ["ProduktInt17","ProduktInt17","ProduktInt17","ProduktInt17"] },									{ Attribut: "ProduktInt18",lang: ["ProduktInt18","ProduktInt18","ProduktInt18","ProduktInt18"] },									{ Attribut: "ProduktInt19",lang: ["ProduktInt19","ProduktInt19","ProduktInt19","ProduktInt19"] },									{ Attribut: "ProduktInt20",lang: ["ProduktInt20","ProduktInt20","ProduktInt20","ProduktInt20"] },									{ Attribut: "ProduktInt21",lang: ["ProduktInt21","ProduktInt21","ProduktInt21","ProduktInt21"] },									{ Attribut: "ProduktInt22",lang: ["ProduktInt22","ProduktInt22","ProduktInt22","ProduktInt22"] },									{ Attribut: "ProduktInt23",lang: ["ProduktInt23","ProduktInt23","ProduktInt23","ProduktInt23"] },									{ Attribut: "ProduktInt24",lang: ["ProduktInt24","ProduktInt24","ProduktInt24","ProduktInt24"] },									{ Attribut: "ProduktInt25",lang: ["ProduktInt25","ProduktInt25","ProduktInt25","ProduktInt25"] },									{ Attribut: "ProduktInt26",lang: ["ProduktInt26","ProduktInt26","ProduktInt26","ProduktInt26"] },									{ Attribut: "ProduktInt27",lang: ["ProduktInt27","ProduktInt27","ProduktInt27","ProduktInt27"] },									{ Attribut: "ProduktInt28",lang: ["ProduktInt28","ProduktInt28","ProduktInt28","ProduktInt28"] },									{ Attribut: "ProduktInt29",lang: ["ProduktInt29","ProduktInt29","ProduktInt29","ProduktInt29"] },									{ Attribut: "ProduktInt30",lang: ["ProduktInt30","ProduktInt30","ProduktInt30","ProduktInt30"] },									{ Attribut: "ProduktInt31",lang: ["ProduktInt31","ProduktInt31","ProduktInt31","ProduktInt31"] },									{ Attribut: "ProduktInt32",lang: ["ProduktInt32","ProduktInt32","ProduktInt32","ProduktInt32"] },									{ Attribut: "ProduktInt33",lang: ["ProduktInt33","ProduktInt33","ProduktInt33","ProduktInt33"] },									{ Attribut: "ProduktInt34",lang: ["ProduktInt34","ProduktInt34","ProduktInt34","ProduktInt34"] },									{ Attribut: "ProduktInt35",lang: ["ProduktInt35","ProduktInt35","ProduktInt35","ProduktInt35"] },									{ Attribut: "ProduktInt36",lang: ["ProduktInt36","ProduktInt36","ProduktInt36","ProduktInt36"] },									{ Attribut: "ProduktInt37",lang: ["ProduktInt37","ProduktInt37","ProduktInt37","ProduktInt37"] },									{ Attribut: "ProduktInt38",lang: ["ProduktInt38","ProduktInt38","ProduktInt38","ProduktInt38"] },									{ Attribut: "ProduktInt39",lang: ["ProduktInt39","ProduktInt39","ProduktInt39","ProduktInt39"] },									{ Attribut: "ProduktInt40",lang: ["ProduktInt40","ProduktInt40","ProduktInt40","ProduktInt40"] },									{ Attribut: "ProduktFloat1",lang: ["ONB Price", "ONB-Preis", "Prix ONB", "ONB售价"] },									{ Attribut: "ProduktFloat2",lang: ["Amazon Price", "Amazon-Preis", "Prix Amazon", "亚马逊售价"] },									{ Attribut: "ProduktFloat3",lang: ["Special Offer", "Sonderangebot", "Offre spéciale", "特价"] },									{ Attribut: "ProduktFloat4",lang: ["ProduktFloat4","ProduktFloat4","ProduktFloat4","ProduktFloat4"] },									{ Attribut: "ProduktFloat5",lang: ["ProduktFloat5","ProduktFloat5","ProduktFloat5","ProduktFloat5"] },									{ Attribut: "ProduktFloat6",lang: ["ProduktFloat6","ProduktFloat6","ProduktFloat6","ProduktFloat6"] },									{ Attribut: "ProduktFloat7",lang: ["ProduktFloat7","ProduktFloat7","ProduktFloat7","ProduktFloat7"] },									{ Attribut: "ProduktFloat8",lang: ["ProduktFloat8","ProduktFloat8","ProduktFloat8","ProduktFloat8"] },									{ Attribut: "ProduktFloat9",lang: ["ProduktFloat9","ProduktFloat9","ProduktFloat9","ProduktFloat9"] },									{ Attribut: "ProduktFloat10",lang: ["ProduktFloat10","ProduktFloat10","ProduktFloat10","ProduktFloat10"] },									{ Attribut: "ProduktFloat11",lang: ["ProduktFloat11","ProduktFloat11","ProduktFloat11","ProduktFloat11"] },									{ Attribut: "ProduktFloat12",lang: ["ProduktFloat12","ProduktFloat12","ProduktFloat12","ProduktFloat12"] },									{ Attribut: "ProduktFloat13",lang: ["ProduktFloat13","ProduktFloat13","ProduktFloat13","ProduktFloat13"] },									{ Attribut: "ProduktFloat14",lang: ["ProduktFloat14","ProduktFloat14","ProduktFloat14","ProduktFloat14"] },									{ Attribut: "ProduktFloat15",lang: ["ProduktFloat15","ProduktFloat15","ProduktFloat15","ProduktFloat15"] },									{ Attribut: "ProduktFloat16",lang: ["ProduktFloat16","ProduktFloat16","ProduktFloat16","ProduktFloat16"] },									{ Attribut: "ProduktFloat17",lang: ["ProduktFloat17","ProduktFloat17","ProduktFloat17","ProduktFloat17"] },									{ Attribut: "ProduktFloat18",lang: ["ProduktFloat18","ProduktFloat18","ProduktFloat18","ProduktFloat18"] },									{ Attribut: "ProduktFloat19",lang: ["ProduktFloat19","ProduktFloat19","ProduktFloat19","ProduktFloat19"] },									{ Attribut: "ProduktFloat20",lang: ["ProduktFloat20","ProduktFloat20","ProduktFloat20","ProduktFloat20"] },									{ Attribut: "ProduktFloat21",lang: ["ProduktFloat21","ProduktFloat21","ProduktFloat21","ProduktFloat21"] },									{ Attribut: "ProduktFloat22",lang: ["ProduktFloat22","ProduktFloat22","ProduktFloat22","ProduktFloat22"] },									{ Attribut: "ProduktFloat23",lang: ["ProduktFloat23","ProduktFloat23","ProduktFloat23","ProduktFloat23"] },									{ Attribut: "ProduktFloat24",lang: ["ProduktFloat24","ProduktFloat24","ProduktFloat24","ProduktFloat24"] },									{ Attribut: "ProduktFloat25",lang: ["ProduktFloat25","ProduktFloat25","ProduktFloat25","ProduktFloat25"] },									{ Attribut: "ProduktFloat26",lang: ["ProduktFloat26","ProduktFloat26","ProduktFloat26","ProduktFloat26"] },									{ Attribut: "ProduktFloat27",lang: ["ProduktFloat27","ProduktFloat27","ProduktFloat27","ProduktFloat27"] },									{ Attribut: "ProduktFloat28",lang: ["ProduktFloat28","ProduktFloat28","ProduktFloat28","ProduktFloat28"] },									{ Attribut: "ProduktFloat29",lang: ["ProduktFloat29","ProduktFloat29","ProduktFloat29","ProduktFloat29"] },									{ Attribut: "ProduktFloat30",lang: ["ProduktFloat30","ProduktFloat30","ProduktFloat30","ProduktFloat30"] },									{ Attribut: "ProduktFloat31",lang: ["ProduktFloat31","ProduktFloat31","ProduktFloat31","ProduktFloat31"] },									{ Attribut: "ProduktFloat32",lang: ["ProduktFloat32","ProduktFloat32","ProduktFloat32","ProduktFloat32"] },									{ Attribut: "ProduktFloat33",lang: ["ProduktFloat33","ProduktFloat33","ProduktFloat33","ProduktFloat33"] },									{ Attribut: "ProduktFloat34",lang: ["ProduktFloat34","ProduktFloat34","ProduktFloat34","ProduktFloat34"] },									{ Attribut: "ProduktFloat35",lang: ["ProduktFloat35","ProduktFloat35","ProduktFloat35","ProduktFloat35"] },									{ Attribut: "ProduktFloat36",lang: ["ProduktFloat36","ProduktFloat36","ProduktFloat36","ProduktFloat36"] },									{ Attribut: "ProduktFloat37",lang: ["ProduktFloat37","ProduktFloat37","ProduktFloat37","ProduktFloat37"] },									{ Attribut: "ProduktFloat38",lang: ["ProduktFloat38","ProduktFloat38","ProduktFloat38","ProduktFloat38"] },									{ Attribut: "ProduktFloat39",lang: ["ProduktFloat39","ProduktFloat39","ProduktFloat39","ProduktFloat39"] },									{ Attribut: "ProduktFloat40",lang: ["ProduktFloat40","ProduktFloat40","ProduktFloat40","ProduktFloat40"] },									{ Attribut: "ProduktBIT1",lang: ["Product Status", "Produktstatus", "Statut du produit", "产品状态"] },									{ Attribut: "ProduktBIT2",lang: ["Variants exist", "Varianten vorhanden", "Des variantes existent", "存在变体"] },									{ Attribut: "ProduktBIT3",lang: ["ProduktBIT3","ProduktBIT3","ProduktBIT3","ProduktBIT3"] },									{ Attribut: "ProduktBIT4",lang: ["ProduktBIT4","ProduktBIT4","ProduktBIT4","ProduktBIT4"] },									{ Attribut: "ProduktBIT5",lang: ["ProduktBIT5","ProduktBIT5","ProduktBIT5","ProduktBIT5"] },									{ Attribut: "ProduktBIT6",lang: ["ProduktBIT6","ProduktBIT6","ProduktBIT6","ProduktBIT6"] },									{ Attribut: "ProduktBIT7",lang: ["ProduktBIT7","ProduktBIT7","ProduktBIT7","ProduktBIT7"] },									{ Attribut: "ProduktBIT8",lang: ["ProduktBIT8","ProduktBIT8","ProduktBIT8","ProduktBIT8"] },									{ Attribut: "ProduktBIT9",lang: ["ProduktBIT9","ProduktBIT9","ProduktBIT9","ProduktBIT9"] },									{ Attribut: "ProduktBIT10",lang: ["ProduktBIT10","ProduktBIT10","ProduktBIT10","ProduktBIT10"] }								 ];		  const fields = ["ProduktString1", "ProduktString2", "ProduktString3", "ProduktString4", "ProduktString5", 				  "ProduktString6", "ProduktString7", "ProduktString8", "ProduktString9", "ProduktString10", 				  "ProduktString11", "ProduktString12", "ProduktString13", "ProduktString14", "ProduktString15", 				  "ProduktInt1", "ProduktFloat1"];				    // 语言索引（0 英文，1 德文，2 法文，3 中文）  const headerLangIndex = 3;  const sql = `SELECT ${fields.join(',')} FROM laaver.Produkt WHERE Status = 1`;  const filePath = path.join(__dirname, 'public', 'excel_datei', filename + '.xlsx');    // 根据 fields 顺序生成表头（默认取字段名，如果未翻译）  const headers = fields.map(f => {    const item = showProduktAttributArr.find(e => e.Attribut === f);    return item ? item.lang[headerLangIndex] : f;  });  con.query(sql, (err, rows) => {    if (err) {      console.error('SQL 错误:', err);      return res.status(500).json({ success: false });    }    const wb = new xl.Workbook();    const ws = wb.addWorksheet('Produkt Export');    const style = wb.createStyle({      font: { bold: true },      alignment: { horizontal: 'center' },    });    // 表头    headers.forEach((field, i) => {      ws.cell(1, i + 1).string(field).style(style);    });    // 数据    rows.forEach((row, rowIndex) => {      fields.forEach((field, colIndex) => {        const val = row[field];        if (typeof val === 'number') {          ws.cell(rowIndex + 2, colIndex + 1).number(val);        } else if (typeof val === 'string') {          ws.cell(rowIndex + 2, colIndex + 1).string(unescape(val));        } else if (val && typeof val === 'object' && val.type === 'Buffer') {          ws.cell(rowIndex + 2, colIndex + 1).number(val[0]); // BIT 字段        } else {          ws.cell(rowIndex + 2, colIndex + 1).string(String(val ?? ""));        }      });    });    wb.write(filePath, () => {      res.json({        success: true,        downloadUrl: `/excel_datei/${filename}.xlsx`,        count: rows.length      });    });  });});/**** Excel Export End****//**** MySQL Begin ****/app.post('/General_Select', urlencodedParser, async function (req, res, next) {	const sqlQuery = unescape(req.body.SQL_TXT);    con.query(sqlQuery, (error, results) => {		if (error) {			return res.json({ success: false, error: 1 });		}		res.json({			results: results		});	}); });app.post('/General_Update', urlencodedParser, async function (req, res, next) {	const sqlQuery = unescape(req.body.SQL_TXT);    con.query(sqlQuery, (error, results) => {		if (error) {			return res.json({ success: false, error: 1 });		}		res.json({			results: results		});	}); });app.post('/General_Insert', urlencodedParser, async function (req, res, next) {	const sqlQuery = unescape(req.body.SQL_TXT);    con.query(sqlQuery, (error, results) => {		if (error) {			return res.json({ success: false, error: 1 });		}		res.json({			results: results		});	}); });app.post('/General_Delete', urlencodedParser, async function (req, res, next) {	const sqlQuery = unescape(req.body.SQL_TXT);    con.query(sqlQuery, (error, results) => {		if (error) {			return res.json({ success: false, error: 1 });		}		res.json({			results: results		});	}); });app.post('/General_Insert_Ids', urlencodedParser, async function (req, res, next) {    const sqlQuery = unescape(req.body.SQL_TXT);    con.query(sqlQuery, (error, results) => {        if (error) {            console.error("SQL Error:", error);            return res.json({ success: false, error: 1 });        }        // 默认返回值        let response = { success: true, results };        // 如果是 insert 语句，就生成新 ID 列表        if (sqlQuery.trim().toUpperCase().startsWith("INSERT")) {            let insertIds = [];            // results.insertId 是第一个插入的 ID            // results.affectedRows 是插入的行数            if (results.insertId && results.affectedRows) {                for (let i = 0; i < results.affectedRows; i++) {                    insertIds.push(results.insertId + i);                }            }            response.insertIds = insertIds;        }        res.json(response);    });});app.post('/Dashboard_1', async (req, res) => {    const sqlQuery = "SELECT Vertreter.*, '' AS VertreterString5 FROM laaver.Vertreter WHERE prIDX="+unescape(req.body.UserID)+"";    con.query(sqlQuery, (error, results) => {        if (error) {			console.error('Error connecting:', error.message);            return res.json({ success: false, error: 1 });        }		res.json({            results: results        });    }); });app.post('/Dashboard_2', async (req, res) => {	const UserID = unescape(req.body.UserID);	const VertreterString3 = unescape(req.body.VertreterString3);	const VertreterString4 = unescape(req.body.VertreterString4);	const VertreterString6 = unescape(req.body.VertreterString6);	const VertreterString7 = unescape(req.body.VertreterString7);	const VertreterString20 = unescape(req.body.VertreterString20);	const VertreterString21 = unescape(req.body.VertreterString21);	const VertreterString22 = unescape(req.body.VertreterString22);	const VertreterString23 = unescape(req.body.VertreterString23);	    const sqlQuery = "UPDATE laaver.Vertreter SET VertreterString3='"+VertreterString3+"',VertreterString4='"+VertreterString4+"',VertreterString6='"+VertreterString6+"',VertreterString7='"+VertreterString7+"',VertreterString20='"+VertreterString20+"',VertreterString21='"+VertreterString21+"',VertreterString22='"+VertreterString22+"',VertreterString23='"+VertreterString23+"' WHERE prIDX="+UserID+"";    con.query(sqlQuery, (error, results) => {        if (error) {			console.error('Error connecting:', error.message);            return res.json({ success: false, error: 1 });        }		res.json({            results: results        });    }); });app.post('/Dashboard_3', async (req, res) => {    const UserID = unescape(req.body.UserID);    const newPassword = unescape(req.body.newPassword);    const sqlQuery = "UPDATE laaver.Vertreter SET VertreterString5='" + newPassword + "' WHERE prIDX="+UserID+"";    con.query(sqlQuery, (error, results) => {        if (error) {            console.error('Error updating password:', error.message);            return res.json({ success: false, error: 1 });        }        res.json({            success: true,            results: results        });    });});app.post('/Mitarbeiter_Nachricht', urlencodedParser, async function (req, res, next) {	const sqlQuery = unescape(req.body.SQL_TXT);    con.query(sqlQuery, (error, results) => {		if (error) {			return res.json({ success: false, error: 1 });		}		res.json({			results: results		});	}); });app.post('/Email_Syn_Func', urlencodedParser, function (req, res) {	const EmailImportTempArr = JSON.parse(req.body.EmailImportTempArr);	let txtList = [];	let processed = 0;	if (!EmailImportTempArr || EmailImportTempArr.length === 0) return res.send("");	EmailImportTempArr.forEach((item, index) => {		const checkSQL = "SELECT prIDX FROM `laaver`.Email_Import WHERE " +			"EmailImportString10=? AND EmailImportString12=? AND EmailImportString13=? AND " +			"DATE_FORMAT(Datum1,'%Y-%m-%d %H:%i')=DATE_FORMAT(?, '%Y-%m-%d %H:%i')";		const checkParams = [item.EmailImportString10, item.EmailImportString12, item.EmailImportString13, item.Datum1];		con.query(checkSQL, checkParams, function (err, exists) {			if (err) return res.status(500).send("1");			if (exists.length > 0) {				txtList[index] = exists[0].prIDX;				finishOne();			} else {				const kundenSQL = "SELECT prIDX, CONCAT(KundenString12, ' ', KundenString13) AS EmailImportString14 FROM `laaver`.Kunden WHERE KundenString11 = ? LIMIT 1";				con.query(kundenSQL, [item.EmailImportString10], function (err, kundenRows) {					if (err) return res.status(500).send("1");					let Kunden = 0, EmailImportString14 = '';					if (kundenRows.length > 0) {						Kunden = kundenRows[0].prIDX;						EmailImportString14 = kundenRows[0].EmailImportString14;					}					const insertSQL = "INSERT INTO `laaver`.Email_Import " +						"(Datum1,Datum2,EmailImportString10,EmailImportString11,EmailImportString12,EmailImportString13," +						"EmailImportBIT1,EmailImportString20,EmailImportString21,EmailImportString22,EmailImportString23," +						"EmailImportString24,EmailImportString25,EmailImportString26,EmailImportString27,EmailImportString28," +						"EmailImportString29,EmailImportInt1,EmailImportInt3,EmailImportString14) " +						"VALUES (NOW(),NOW(),?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";					const insertParams = [						item.EmailImportString10, item.EmailImportString11, (String(item.EmailImportString12)==("undefined")?"":item.EmailImportString12) , item.EmailImportString13,						item.EmailImportBIT1,						item.EmailImportString20, item.EmailImportString21, item.EmailImportString22, item.EmailImportString23,						item.EmailImportString24, item.EmailImportString25, item.EmailImportString26, item.EmailImportString27,						item.EmailImportString28, item.EmailImportString29,						Kunden, item.EmailImportInt3, EmailImportString14					];					con.query(insertSQL, insertParams, function (err) {						if (err) return res.status(500).send("1");						con.query("SELECT prIDX FROM `laaver`.Email_Import ORDER BY prIDX DESC LIMIT 1", function (err, idRows) {							if (err) return res.status(500).send("1");							const prIDX = idRows[0].prIDX;							txtList[index] = prIDX;							con.query("SELECT 1 FROM `laaver`.Email_Spam WHERE EmailSpamString1 = ? LIMIT 1", [item.EmailImportString10], function (err, spamRows) {								if (!err && spamRows.length > 0) {									con.query("UPDATE `laaver`.Email_Import SET Status=8 WHERE prIDX=?", [prIDX], function () {										finishOne();									});								} else {									finishOne();								}							});						});					});				});			}		});	});	function finishOne() {		processed++;		if (processed === EmailImportTempArr.length) {			res.send(txtList.join("##"));		}	}});app.post('/Email_Syn_Func_1', urlencodedParser, function (req, res) {	const raw = req.body.newEmailImportArr;	if (!raw) return res.send("NO DATA");	let newArr;	try {		newArr = JSON.parse(raw);	} catch (e) {		return res.status(400).send("INVALID JSON");	}	if (!Array.isArray(newArr) || newArr.length === 0) return res.send("EMPTY");	// 一次性获取 KundenAllgemeinArr	con.query("SELECT prIDX, KundenString10, KundenString11, KundenString12, KundenString13 FROM `laaver`.kunden", function (err, kundenRows) {		if (err) return res.status(500).send("DB ERROR");		let updateList = [];		for (let i = 0; i < newArr.length; i++) {			const email = newArr[i].EmailImportString10?.toLowerCase();			const prIDX = parseInt(newArr[i].prIDX);			const existingName = newArr[i].EmailImportString14;			if (!email || !prIDX || existingName === "") continue;			for (let j = 0; j < kundenRows.length; j++) {				const k = kundenRows[j];				if (email === k.KundenString11.toLowerCase()) {					const name = k.KundenString13 ? `${k.KundenString12} ${k.KundenString13}` : k.KundenString10;					updateList.push([name, k.prIDX, prIDX]);					break;				}			}		}		if (updateList.length === 0) return res.send("NO MATCH");		let done = 0;		updateList.forEach(item => {			con.query(				"UPDATE `laaver`.email_import SET EmailImportString14=?, EmailImportInt1=? WHERE prIDX=?",				item,				function () {					done++;					if (done === updateList.length) res.send("OK");				}			);		});	});});app.post("/Bestellung_Email_Read", urlencodedParser, (req, res) => {	const OneBestellung = JSON.parse(req.body.OneBestellung || "{}");	const timeString = "laaver_Email_Read_" + req.body.Time;	const prIDX = parseInt(OneBestellung.prIDX);	const BestellungInt1 = parseInt(OneBestellung.BestellungInt1);	if (!prIDX || !BestellungInt1) {		return res.status(400).json({ success: false, msg: "Fehlende Daten" });	}	const selectSql = "SELECT BestellungBIT1 FROM `laaver`.Bestellung WHERE prIDX = ?";	con.query(selectSql, [prIDX], (err, result) => {		if (err) return res.status(500).json({ success: false, msg: "Select Error", error: err });		if (result.length === 0) {			return res.json({ success: true, msg: "Keine Bestellung gefunden" });		}		if (result[0].BestellungBIT1 === 0) {			const updateEmailSql = "UPDATE `laaver`.Email_Import SET EmailImportInt5 = 1 WHERE EmailImportInt3 = ?";			const updateBestellungSql = "UPDATE `laaver`.Bestellung SET BestellungBIT1 = 1, BestellungString21 = ? WHERE prIDX = ?";			con.query(updateEmailSql, [BestellungInt1], (err1) => {				if (err1) return res.status(500).json({ success: false, msg: "Update Email Error", error: err1 });				con.query(updateBestellungSql, [timeString, prIDX], (err2) => {					if (err2) return res.status(500).json({ success: false, msg: "Update Bestellung Error", error: err2 });					res.json({ success: true });				});			});		} else {			res.json({ success: true, msg: "Bereits gelesen" });		}	});});/**** MySQL End ****//**** PDF Code Begin****/app.post('/Rechnung_PDF', urlencodedParser, function (req, res, next){		const oneRechnungMain = JSON.parse(req.body.oneRechnungMain);	const MittelIDX = parseInt(req.body.MittelIDX);	const Today = String(req.body.Today);	//const Today = "08.05.2023";  //指定账单日期	const idx1 = parseInt(req.body.idx1);	const idx2 = parseInt(req.body.idx2);	const VAT = unescape(req.body.VAT);		var filename = "",html_template = "";	var PDFlang = "";	if(parseInt(oneRechnungMain.RechnungInt4)==0) PDFlang = "DE";	else if(parseInt(oneRechnungMain.RechnungInt4)==1) PDFlang = "EN";		switch(idx1){		case 1: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString21; html_template = "PI_"+PDFlang; break;		case 2: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString22; html_template = "R_"+PDFlang; break;		case 3: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString23; html_template = "ZE_"+PDFlang; break;		case 4: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString24; html_template = "M1_"+PDFlang; break;		case 5: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString25; html_template = "M2_"+PDFlang; break;		case 6: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString26; html_template = "M3_"+PDFlang; break;		case 7: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString27; html_template = "SR_"+PDFlang; break;		case 8: filename = oneRechnungMain.Mittel[idx2].RechnungMittelString28; html_template = "G_"+PDFlang; break;	}		var MittelArr = oneRechnungMain.Mittel[idx2];	MittelArr.RechnungMittelFloat1 = parseFloat(MittelArr.RechnungMittelFloat1).toFixed(2).replace(".",",");	MittelArr.RechnungMittelFloat2 = parseFloat(MittelArr.RechnungMittelFloat2).toFixed(2).replace(".",",");	MittelArr.RechnungMittelFloat3 = parseFloat(MittelArr.RechnungMittelFloat3).toFixed(2).replace(".",",");	MittelArr.RechnungMittelFloat4 = parseFloat(MittelArr.RechnungMittelFloat4).toFixed(2).replace(".",",");	MittelArr.showSteuer = "";	if(parseInt(MittelArr.RechnungMittelFloat1)==0) MittelArr.showSteuer = "display:none;";				var PosArr1 = new Array(),PosArr2 = new Array(),iCount=1;	for(var i=0; i<oneRechnungMain.Mittel[idx2].Pos.length; i++){		if(oneRechnungMain.Mittel[idx2].Pos[i].RechnungPosInt1==1){			PosArr1.push(oneRechnungMain.Mittel[idx2].Pos[i]);			PosArr1[PosArr1.length-1].RechnungInt16 = parseInt(iCount);			PosArr1[PosArr1.length-1].RechnungPosString10 = unescape(PosArr1[PosArr1.length-1].RechnungPosString10);			PosArr1[PosArr1.length-1].RechnungPosFloat1 = parseFloat(PosArr1[PosArr1.length-1].RechnungPosFloat1).toFixed(2).replace(".",",");			PosArr1[PosArr1.length-1].RechnungPosFloat2 = parseFloat(PosArr1[PosArr1.length-1].RechnungPosFloat2).toFixed(2).replace(".",",");			PosArr1[PosArr1.length-1].RechnungPosFloat3 = parseFloat(PosArr1[PosArr1.length-1].RechnungPosFloat3).toFixed(2).replace(".",",");			PosArr1[PosArr1.length-1].RechnungPosFloat4 = parseFloat(PosArr1[PosArr1.length-1].RechnungPosFloat4).toFixed(2).replace(".",",");			iCount++;		}	}		for(var i=0; i<oneRechnungMain.Mittel[idx2].Pos.length; i++){		if(oneRechnungMain.Mittel[idx2].Pos[i].RechnungPosInt1==2){			PosArr2.push(oneRechnungMain.Mittel[idx2].Pos[i]);			PosArr2[PosArr2.length-1].RechnungPosString10 = unescape(PosArr2[PosArr2.length-1].RechnungPosString10);			PosArr2[PosArr2.length-1].RechnungPosString11 = unescape(PosArr2[PosArr2.length-1].RechnungPosString11);		}	}		var showBeschreibung = "";	if(PosArr2.length==0) showBeschreibung = "display:none;";		var footerTXT = "<table style='margin-left:12px;width:69%;font-size:12px;color:#AAA;border-top:2px solid #AAA;'><tr>"+					"<td>Geschäftsführer: Shi Ding<br/>AmtsG:  Frankfurt a.M. HRB 109789<br/>USt-IdNr.: DE316185757<br/>St.-Nr.: 040 246 34555</td>"+					"<td style='text-align:right;'>Bank of China, Frankfurt a.M.<br/>IBAN: DE84 5141 0700 9700 4445 98(€)<br/>Taunus Sparkasse<br/>IBAN： DE54 5125 0000 0002 2354 04(€)</td>"+					"</tr><tr><td colspan='2' style='text-align:right;'><span>{{page}}</span>/<span>{{pages}}</span></td></tr></table>";			var dest_file_path = String(__dirname + "/pdf_template/"+html_template+".html");	var htmlFile = fs.readFileSync(dest_file_path, "utf8");	var document = {	  html: htmlFile,	  data: {				oneRechnungMain: oneRechnungMain,				VAT: VAT,				MittelArr: MittelArr,				PosArr1: PosArr1,				PosArr2: PosArr2,				showBeschreibung: showBeschreibung,				Today: Today,			},	  path: "./public/pdf_datei/"+filename+".pdf",	  type: "",	};	var options = {		format: "A4",		orientation: "portrait",		border: "10mm",		header: {			height: "5mm"		},		footer: {			height: "25mm",            contents: {                default: footerTXT,            }		}	};	pdf.create(document, options).then((response) => {		return res.end();	}).catch((error) => {		console.error(error);	});});app.post('/Reklamation_Rechnung_PDF', urlencodedParser, function (req, res, next){		const OneReklamation = JSON.parse(req.body.OneReklamation);	const OneBillingAdresseAllgemein = JSON.parse(req.body.OneBillingAdresseAllgemein);	const OneShippingAdresseAllgemein = JSON.parse(req.body.OneShippingAdresseAllgemein);	const ReklamationArtikelArr = JSON.parse(req.body.ReklamationArtikelArr);	const filename = String(req.body.filename);		var tempReklamationArr = new Array();	for(var i=0; i<ReklamationArtikelArr.length; i++){		tempReklamationArr.push(new tempReklamationObj(parseInt(i+1),													 unescape(ReklamationArtikelArr[i].ReklamationArtikelString10),													 unescape(ReklamationArtikelArr[i].ReklamationArtikelString14),													 parseInt(ReklamationArtikelArr[i].ReklamationArtikelInt4),													 FCommaEUR(parseFloat(parseFloat(ReklamationArtikelArr[i].ReklamationArtikelFloat5).toFixed(2))),													 FCommaEUR(parseFloat(parseInt(ReklamationArtikelArr[i].ReklamationArtikelInt4) * parseFloat(parseFloat(ReklamationArtikelArr[i].ReklamationArtikelFloat5)).toFixed(2)))													 ));	}	var footerTXT = ""+		"<table style='width:100%;font-size:10px;color:#AAA;border-top:2px solid #AAA;' cellpadding='1'><tr>"+		"<td style='width:24%;padding-top:5px;vertical-align:top;'>ITinDE UG<br/>Annastraße 97<br/>D-63225 Langen(Hessen)<br/>Germany<br/><br/></td>"+		"<td style='width:28%;padding-top:5px;vertical-align:top;'>Amtsgericht Offenbach am Main<br/>HRB 52022<br/>Geschäftsführer: Zongwei Lin<br/>Ust-IdNr.: DE328220084<br/><br/></td>"+				"<td style='width:20%;padding-top:5px;vertical-align:top;'>Bank: Postbank<br/>Kontoinhaber: Zongwei Lin<br/>IBAN: DE91 4401 0046 0513 1144 69<br/>BIC: PBNKDEFF<br/><br/><div style='text-align:right;'>{{page}}/{{pages}}</div></td>"+		"<td style='width:100px;padding-top:5px;vertical-align:top;'>&nbsp;</td>"+		"</tr></table>";			var dest_file_path = String(__dirname + "/public/pdf_template/Gutschrift_Rechnung.html");	var htmlFile = fs.readFileSync(dest_file_path, "utf8");	var document = {	  html: htmlFile,	  data: {				tempReklamationArr: tempReklamationArr,				BillingName: unescape(OneBillingAdresseAllgemein.BestellungBillingString11),				BillingAdresse1: unescape(OneBillingAdresseAllgemein.BestellungBillingString13),				BillingAdresse2: unescape(OneBillingAdresseAllgemein.BestellungBillingString14),				BillingPLZ: unescape(OneBillingAdresseAllgemein.BestellungBillingString17),				BillingStadt: unescape(OneBillingAdresseAllgemein.BestellungBillingString15),				BillingStaat: unescape(OneBillingAdresseAllgemein.BestellungBillingString18),				Erstellungsdatum: unescape(OneReklamation.Datum1),				ReklamationNr: String("R"+parseInt(parseInt(OneReklamation.prIDX)+10000)),				Email: unescape(OneReklamation.ReklamationString22),							Summe: FCommaEUR(OneReklamation.ReklamationFloat5),							},	  path: "./public/pdf_datei/"+filename+".pdf",	  type: "",	};	var options = {		format: "A4",		orientation: "portrait",		border: "10mm",		header: {			height: "5mm"		},		footer: {			height: "20mm",            contents: {                default: footerTXT,            }		}	};	pdf.create(document, options).then((response) => {		return res.end();	}).catch((error) => {		console.error(error);	});});function tempReklamationObj(iCount,Name,Attribute,Menge,Einzelpreis,Zwischensumme){	this.iCount=iCount;	this.Name=Name;	this.Attribute=Attribute;	this.Menge=Menge;	this.Einzelpreis=Einzelpreis;	this.Zwischensumme=Zwischensumme;}  function FCommaEUR(SS){ 	return parseFloat(SS).toFixed(2).replace(".", ",").replace(/(\d)(?=(\d{3})+\,)/g, '$1.'); }/**** PDF Code End****//**** Send Email Begin ****/app.post('/SendEmailFunc', urlencodedParser , function (req, res){	var Mitarbeiter = String(req.body.Mitarbeiter);	var prIDX = String(req.body.prIDX);	var KundenListe = unescape(req.body.KundenListe);	var BestellungIDX = parseInt(req.body.BestellungIDX);	var BestellungTXT = unescape(req.body.BestellungTXT);	var txt = "";	txt = "SELECT mainTable.*,M.Footer,M.FooterContent FROM `laaver`.Sendmail AS mainTable "+		  "INNER JOIN `laaver`.Mitarbeiter AS M ON M.prIDX=mainTable.Mitarbeiter "+		  "WHERE mainTable.Status=1 AND mainTable.prIDX="+prIDX+"";										con.query(txt, function (err1, rows1) {		async.each(rows1, function (row1, callback) {					for (var row1 of rows1) {				for (var i=0; i<KundenListe.split(",").length; i++) {					con.query("SELECT * FROM `laaver`.kunde WHERE prIDX="+parseInt(KundenListe.split(",")[i])+"", function (err2, rows2) {						async.each(rows2, function (row2, callback) {									for (var row2 of rows2) {																var mailTXT = unescape(row1.Body+"<br/><br/><br/><br/>"+row1.Footer).replace(/{{Firma}}/ig,unescape(row2.Firma))																									.replace(/{{Vorname}}/ig,unescape(row2.first_name))																									.replace(/{{Nachname}}/ig,unescape(row2.last_name));								var Title = unescape(row1.Title);								if(parseInt(req.body.BestellungIDX)>0)									Title = Title.replace("{{BestellungIDX}}",String("B"+parseInt(10000+parseInt(req.body.BestellungIDX))));								if(BestellungTXT!="") 									mailTXT = mailTXT.replace("{{BestellungTXT_A}}",String(BestellungTXT.split("###")[1]))													 .replace("{{BestellungTXT_B}}",String(BestellungTXT.split("###")[2]));																async function main() {								  let transporter = nodemailer.createTransport({									host: "laaver.com",									port: 465,									secure: true,									auth: {									  user: "info@laaver.com", 									  pass: "Ka*8_8wDzFi5lrnv", 									},									logger: false,								  });								  let info = await transporter.sendMail({									from: '"laaver" <info@laaver.com>', 									to: unescape(row2.email),									subject: Title,									html: mailTXT,								  });				  								}								main().catch(console.error);								}							});											});				}								res.end();			}		});		});	 });/**** Send Email End ****//**** Send Kunden Email Begin ****/app.post('/Send_Email_Kunden', urlencodedParser, function (req, res){	var KundenEmail = String(req.body.KundenEmail);	var MitarbeiterName = unescape(req.body.MitarbeiterName);	var Title = unescape(req.body.Title);	var Inhalt = unescape(req.body.Inhalt);	var OldEmailInhalt = unescape(req.body.OldEmailInhalt);		var EmailArr = new Array();		if(isValidEmail(KundenEmail)) EmailArr.push(KundenEmail);		var Subject = Title;	var Content = "<br/><div style='font-size:18px;'>Hallo,<br/><br/>"+Inhalt+"</div><br/><br/><br/><br/>"+				  "<img src='https://www.laaver.com/images/banner.png' /><br/><br/>"+				  "<div style='font-size:18px;'>"+				  "Mit freundlichen grüßen<br/>laaver Team<br/>"+MitarbeiterName+"<br/><br/>"+				  "Website: <a href='https://www.laaver.com/'>www.laaver.com</a><br/>"+				  "Email: <a href='mailto:info@laaver.com'>info@laaver.com</a><br/>"+				  "</div>"+				  "<div style='font-size:14px;color:#AAA;'>"+OldEmailInhalt+"</div>";		SendEmailKundenFunc(EmailArr,0,Subject,Content,res);});app.post('/Complete_Order_And_Send_Email', urlencodedParser, function (req, res){	var KundenEmail = String(req.body.KundenEmail);	var MitarbeiterName = unescape(req.body.MitarbeiterName);	var Title = unescape(req.body.Title);	var Inhalt = unescape(req.body.Inhalt);	var OldEmailInhalt = unescape(req.body.OldEmailInhalt);		var EmailArr = new Array();		if(isValidEmail(KundenEmail)) EmailArr.push(KundenEmail);		var Subject = Title;	var Content = "<br/><div style='font-size:18px;'>Hallo,<br/><br/>"+Inhalt+"</div><br/><br/><br/><br/>"+				  "<img src='https://www.laaver.com/images/banner.png' /><br/><br/>"+				  "<div style='font-size:18px;'>"+				  "Mit freundlichen grüßen<br/>laaver Team<br/>"+MitarbeiterName+"<br/><br/>"+				  "Website: <a href='https://www.laaver.com/'>www.laaver.com</a><br/>"+				  "Email: <a href='mailto:info@laaver.com'>info@laaver.com</a><br/>"+				  "</div>"+				  "<div style='font-size:14px;color:#AAA;'>"+OldEmailInhalt+"</div>";		SendEmailKundenFunc(EmailArr,0,Subject,Content,res);});function SendEmailKundenFunc(EmailArr,idx,Subject,Content,res){					let transporter = nodemailer.createTransport(smtpConfig);	let mailOptions = {	  from: mailFrom,	  to: EmailArr[idx],	  subject: Subject,	  html: Content,	};	transporter.sendMail(mailOptions, function(error, info){	  if (error) {		console.log('Node - ' + error);	  } else {		//console.log('Email sent: ' + info.response);	  }	  	  if(idx<EmailArr.length-1){		SendEmailKundenFunc(EmailArr,parseInt(idx+1),Subject,Content,res);	  }else{		res.end();	  }	});}function isValidEmail(email) {  var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;  return emailRegex.test(email);}app.post('/email_import_update', urlencodedParser, function (req, res) {	const { UserID, Inhalt, Title, prIDX } = req.body;	if (!UserID || !Inhalt || !Title || !prIDX) { 		return res.status(400).json({ error: 'Missing parameters' });	}	const sql = `		UPDATE laaver.Email_Import		SET Status = 2,			EmailImportBIT2 = 1,			EmailImportInt2 = ${parseInt(UserID)},			EmailImportString15 = '${escape(Title)}',			EmailImportString16 = '${escape(Inhalt)}'		WHERE prIDX = ${parseInt(prIDX)};	`;	con.query(sql, (error, results) => {		if (error) {			return res.json({ success: false, error: 1 });		}		res.json({			results: results		});	}); });app.post('/Email_Send_Insert', urlencodedParser, async function (req, res) {	const {		EmailImportString10,		EmailImportString11,		EmailImportString12,		EmailImportString13,		EmailImportInt1,		EmailImportInt2,		EmailImportInt3,		BestellungInt1	} = req.body;	if (!EmailImportString11 || !EmailImportString12 || !EmailImportString13 || !EmailImportInt1 || !EmailImportInt2 || !EmailImportInt3 || !BestellungInt1) {		return res.status(400).json({ error: 'Missing fields' });	}	const insertSQL = `		INSERT INTO laaver.Email_Import		(Status, EmailImportString10, EmailImportString11, EmailImportString12, EmailImportString13, EmailImportInt1, EmailImportInt2, EmailImportInt3, EmailImportInt4)		VALUES (3,?,?,?,?,?,?,?,1)		`;	const insertParams = [		EmailImportString10,		EmailImportString11,		EmailImportString12,		EmailImportString13,		parseInt(EmailImportInt1),		parseInt(EmailImportInt2),		parseInt(EmailImportInt3)	];	const updateSQL = `		UPDATE laaver.Email_Import		SET EmailImportBIT2 = 1		WHERE EmailImportInt3 = ?	`;	con.query(insertSQL, insertParams, function (err) {		if (err) {			console.error(err);			return res.status(500).json({ error: 'Insert failed' });		}		con.query(updateSQL, [parseInt(BestellungInt1)], function (err2) {			if (err2) {				console.error(err2);				return res.status(500).json({ error: 'Update failed' });			}			res.json({ success: true });		});	});});/**** Send Kunden Email End ****//**** Email Syn Begin ****/app.post('/Email_Import_Func', urlencodedParser, function (req, res, next) {    function formatDate(dateString) {        const months = [            'January', 'February', 'March', 'April', 'May', 'June', 'July',            'August', 'September', 'October', 'November', 'December'        ];        const [year, month, day] = dateString.split('-');        const monthIndex = parseInt(month, 10) - 1;        const formattedDate = `${months[monthIndex]} ${parseInt(day, 10)}, ${year}`;        return formattedDate;    }    const startDateFormatted = formatDate(req.body.startDateFormatted);    const endDateFormatted = formatDate(req.body.endDateFormatted,res);		Email_Import_Func(startDateFormatted,endDateFormatted,1,res);});function Email_Import_Func(startDateFormatted,endDateFormatted,callback,res){    imap.connect();    imap.once('ready', () => {        imap.openBox('INBOX', false, (err, box) => {            if (err) {                console.error(err);                return;            }            const searchCriteria = ['ALL', ['SINCE', startDateFormatted]];            imap.search(searchCriteria, (searchErr, results) => {                if (searchErr) {                    console.error(searchErr);                    return;                }                const messages = []; // 用于保存邮件信息的数组                const f = imap.fetch(results, { bodies: '', markSeen: false });                f.on('message', (msg, seqno) => {                    const message = {                        seqno: seqno, // 邮件序号                        params: {}, // 附件数组                    };                    msg.on('body', (stream, info) => {                        let buffer = '';                        // 读取邮件内容流                        stream.on('data', (chunk) => {                            buffer += chunk.toString('utf8');                        });                        // 邮件内容读取完成后的处理                        stream.on('end', () => {                            message.content = buffer; // 保存邮件内容                            parseMail(message); // 解析邮件内容                        });                    });                    function parseMail(message) {                        simpleParser(message.content, (err, mail) => {                            if (err) {                                console.error('Error parsing mail:', err);                                return;                            }                            const emailObj = {                                subject: mail.subject,                                from: mail.from.text,                                to: mail.to.text,                                date: mail.date,                                body: mail.text || mail.html,                                attachments: [] // 创建一个空数组来存储附件名称                            };                            if (mail.attachments) {								mail.attachments.forEach(attachment => {									//console.log(JSON.stringify(attachment));									const attachmentObj = { // 创建附件对象										filename: attachment.filename,										content: attachment.content,										contentType: attachment.contentType,										contentTransferEncoding: attachment.contentTransferEncoding									};									const thistimestamp = String(new Date().getTime());									emailObj.attachments.push(String(thistimestamp+"_"+attachmentObj.filename)); // 将附件名称添加到邮件对象的附件数组中									// 保存附件到指定目录									const outputFilename = path.join(__dirname, 'public', 'email_datei', String(thistimestamp+"_"+attachment.filename));									fs.writeFile(outputFilename, Buffer.from(attachment.content, attachment.contentTransferEncoding), (err) => {										if (err) {											console.error(`保存附件时出错: ${err}`);											return;										}										//console.log(`附件保存成功: ${outputFilename}`);									});								});							}							                            messages.push(emailObj); // 将邮件对象添加到邮件数组中                            checkIfAllMessagesParsed(); // 检查是否所有邮件都已解析完成                        });                    }                });                function checkIfAllMessagesParsed() {                    if (messages.length === results.length) { // 检查是否所有邮件都已解析完成                        //console.log(messages); // 输出邮件数组                        if(callback==1) res.json(messages); // 将邮件数组作为 JSON 响应发送给客户端						else sortEmailMessages(messages);                        imap.end(); // 关闭 IMAP 连接                    }                }                f.once('error', (fetchErr) => {                    //console.error(fetchErr);                });            });        });    });    imap.once('error', function (err) {        //console.error("imap: " + err);    });    imap.once('end', function () {        //console.log('IMAP 连接已关闭');    });}function sortEmailMessages(response){	var newEmailImportArr = new Array();	for(var i=0; i<response.length; i++){		newEmailImportArr.push(new EmailImportObj());		newEmailImportArr[newEmailImportArr.length-1].Datum1 = response[i].date.toISOString().slice(0, 19).replace('T', ' ');		newEmailImportArr[newEmailImportArr.length-1].EmailImportString10 = extractEmailName(response[i].from);		newEmailImportArr[newEmailImportArr.length-1].EmailImportString11 = extractEmailName(response[i].to);		newEmailImportArr[newEmailImportArr.length-1].EmailImportString12 = escape(response[i].subject);		newEmailImportArr[newEmailImportArr.length-1].EmailImportString13 = escape(response[i].body);		newEmailImportArr[newEmailImportArr.length-1].EmailImportBIT1 = 0;		newEmailImportArr[newEmailImportArr.length-1].EmailImportInt3 = 0;		if(response[i].attachments.length>0){			newEmailImportArr[newEmailImportArr.length-1].EmailImportBIT1 = 1;		}				newEmailImportArr[newEmailImportArr.length-1].EmailImportString20 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString21 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString22 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString23 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString24 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString25 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString26 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString27 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString28 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString29 = "";		newEmailImportArr[newEmailImportArr.length-1].EmailImportString30 = "";				for(var j=0; j<response[i].attachments.length; j++){			if(j<10){				eval("newEmailImportArr[newEmailImportArr.length-1].EmailImportString"+parseInt(20+j)+"=escape(response[i].attachments[j]);");			}		}	}	if(newEmailImportArr.length>0){		for(var i=0; i<newEmailImportArr.length; i++){			var EmailImportString13 = String(newEmailImportArr[i].EmailImportString13).replace(/%0A/ig,"").replace(/%3Cbr%3E/ig,"");			if(isBase64String(EmailImportString13)) {				newEmailImportArr[i].EmailImportString13 = escape(decodeBase64(String(newEmailImportArr[i].EmailImportString13).replace(/%0A/ig,"").replace(/%3Cbr%3E/ig,"")));			}		}					//尝试将邮件拉进相应的订单(通过订单号)		var regex1 = /Bestellnummer #(\d{4,6})/;		var regex2 = /Bestellung: #(\d{4,6})/;		for(var i=0; i<newEmailImportArr.length; i++){ 			var match1 = unescape(newEmailImportArr[i].EmailImportString13).match(regex1);			var match2 = unescape(newEmailImportArr[i].EmailImportString13).match(regex2);			if (match1 && match1[1]) {				newEmailImportArr[i].EmailImportInt3 = parseInt(match1[1]);			}else if (match2 && match2[1]) {				newEmailImportArr[i].EmailImportInt3 = parseInt(match2[1]);			}		}				saveNewEmailImport(newEmailImportArr);	}}function saveNewEmailImport(newEmailImportArr) {    newEmailImportArr.forEach(newEmail => {        con.query("SELECT * FROM `laaver`.Email_Import WHERE EmailImportString10=? AND EmailImportString12=? AND EmailImportString13=? AND DATE_FORMAT(Datum1,'%Y-%m-%d %H:%i')=DATE_FORMAT(?, '%Y-%m-%d %H:%i')", [            newEmail.EmailImportString10,            newEmail.EmailImportString12,            newEmail.EmailImportString13,            newEmail.Datum1        ], function(err, sqlA) {            if (err) {                console.error('Error executing query:', err);                return;            }            var Kunden = 0,                EmailImportString14 = "";            con.query("SELECT * FROM `laaver`.Kunden WHERE KundenString11=?", [newEmail.EmailImportString10], function(err, sqlB) {                if (err) {                    console.error('Error executing query:', err);                    return;                }                if (sqlB.length > 0) {                    Kunden = parseInt(sqlB[0].prIDX);                    EmailImportString14 = sqlB[0].KundenString12 + " " + sqlB[0].KundenString13;                }                if (sqlA.length == 0) {                    con.query("INSERT INTO `laaver`.Email_Import (Datum1,Datum2,EmailImportString10,EmailImportString11,EmailImportString12,EmailImportString13,EmailImportBIT1,EmailImportString20,EmailImportString21,EmailImportString22,EmailImportString23,EmailImportString24,EmailImportString25,EmailImportString26,EmailImportString27,EmailImportString28,EmailImportString29,EmailImportInt1,EmailImportInt3,EmailImportString14) VALUES (?,NOW(),?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)", [                        newEmail.Datum1,                        newEmail.EmailImportString10,                        newEmail.EmailImportString11,                        newEmail.EmailImportString12,                        newEmail.EmailImportString13,                        newEmail.EmailImportBIT1,                        newEmail.EmailImportString20,                        newEmail.EmailImportString21,                        newEmail.EmailImportString22,                        newEmail.EmailImportString23,                        newEmail.EmailImportString24,                        newEmail.EmailImportString25,                        newEmail.EmailImportString26,                        newEmail.EmailImportString27,                        newEmail.EmailImportString28,                        newEmail.EmailImportString29,                        Kunden,                        newEmail.EmailImportInt3,                        EmailImportString14                    ], function(err, result) {                        if (err) {                            console.error('Error inserting record:', err);                            return;                        }                        con.query("SELECT prIDX FROM `laaver`.Email_Import ORDER BY prIDX DESC LIMIT 1", function(err, sqlC) {                            if (err) {                                console.error('Error executing query:', err);                                return;                            }                            if (sqlC.length > 0) {                                con.query("SELECT * FROM `laaver`.Email_Spam WHERE EmailSpamString1=?", [newEmail.EmailImportString10], function(err, sqlD) {                                    if (err) {                                        console.error('Error executing query:', err);                                        return;                                    }                                    if (sqlD.length > 0) {                                        con.query("UPDATE `laaver`.Email_Import SET Status=8 WHERE prIDX=?", [sqlC[0].prIDX], function(err) {                                            if (err) {                                                console.error('Error updating record:', err);                                                return;                                            }                                        });                                    }                                });                            }                        });                    });                }            });        });    });}function EmailImportObj(prIDX,frIDX,Datum1,Datum2,Datum3,Datum4,EmailImportString10,EmailImportString11,EmailImportString12,EmailImportString13,EmailImportInt1,EmailImportInt2,EmailImportInt3,EmailImportInt4,EmailImportFloat1,EmailImportFloat2,EmailImportFloat3,EmailImportFloat4,EmailImportBIT1,EmailImportBIT2,EmailImportString14,EmailImportString15,EmailImportString16,EmailImportString17,EmailImportString18,EmailImportString19,EmailImportString20,EmailImportString21,EmailImportString22,EmailImportString23,EmailImportString24,EmailImportString25,EmailImportString26,EmailImportString27,EmailImportString28,EmailImportString29,EmailImportInt5,Status,EmailImportFloat5,EmailImportFloat6){   this.prIDX=prIDX;   this.frIDX=frIDX;   this.Datum1=Datum1;   this.Datum2=Datum2;   this.Datum3=Datum3;   this.Datum4=Datum4;   this.EmailImportString10=EmailImportString10;   this.EmailImportString11=EmailImportString11;   this.EmailImportString12=EmailImportString12;   this.EmailImportString13=EmailImportString13;   this.EmailImportInt1=EmailImportInt1;   this.EmailImportInt2=EmailImportInt2;   this.EmailImportInt3=EmailImportInt3;   this.EmailImportInt4=EmailImportInt4;   this.EmailImportFloat1=EmailImportFloat1;   this.EmailImportFloat2=EmailImportFloat2;   this.EmailImportFloat3=EmailImportFloat3;   this.EmailImportFloat4=EmailImportFloat4;   this.EmailImportBIT1=EmailImportBIT1;   this.EmailImportBIT2=EmailImportBIT2;   this.EmailImportString14=EmailImportString14;   this.EmailImportString15=EmailImportString15;   this.EmailImportString16=EmailImportString16;   this.EmailImportString17=EmailImportString17;   this.EmailImportString18=EmailImportString18;   this.EmailImportString19=EmailImportString19;   this.EmailImportString20=EmailImportString20;   this.EmailImportString21=EmailImportString21;   this.EmailImportString22=EmailImportString22;   this.EmailImportString23=EmailImportString23;   this.EmailImportString24=EmailImportString24;   this.EmailImportString25=EmailImportString25;   this.EmailImportString26=EmailImportString26;   this.EmailImportString27=EmailImportString27;   this.EmailImportString28=EmailImportString28;   this.EmailImportString29=EmailImportString29;   this.EmailImportInt5=EmailImportInt5;   this.Status=Status;   this.EmailImportFloat5=EmailImportFloat5;   this.EmailImportFloat6=EmailImportFloat6;}function extractEmailName(email) {    const regex = /<([^>]+)>/;    const match = email.match(regex);    if (match && match.length > 1) {        return match[1];    } else {        return email;    }}function isBase64String(str) {  // 使用正则表达式检查字符串是否符合Base64编码的格式  const base64Regex = /^[A-Za-z0-9+/]+[=]{0,2}$/;  return base64Regex.test(str);}/**** Email Syn End ****//**** Angebot Syn End ****/app.post('/Angebot_Syn_Func', urlencodedParser, function (req, res) {    var AngebotArr = [];    const sql = `SELECT P.prIDX,P.ProduktString10,P.ProduktString11,PE.ProduktEinzelFloat1 AS Preis,PE.prIDX AS EinzelIDX,  				AM.prIDX AS AngebotIDX,AM.AngebotMainString17 AS AngebotText,AM.AngebotMainFloat1,AM.AngebotMainFloat2,AM.AngebotMainFloat3,AM.AngebotMainInt1,AM.AngebotMainInt3,  				AM.Datum3,AM.Datum4,  				'' AS AngebotString1,'' AS AngebotString2,'' AS AngebotString3,'' AS AngebotString4,  				0 AS AngebotInt2,0 AS AngebotInt3,0 AS AngebotInt4,  				0 AS AngebotFloat1,0 AS AngebotFloat2,0 AS AngebotFloat3,0 AS AngebotFloat4  				FROM laaver.Produkt AS P  				INNER JOIN laaver.Produkt_Einzel AS PE ON PE.frIDX = P.prIDX  				INNER JOIN laaver.Angebot_Main AS AM ON P.ProduktInt1 = AM.AngebotMainString17  				WHERE AM.AngebotMainInt3 = 2 AND AM.Status = 9 AND CURDATE() BETWEEN AM.Datum3 AND AM.Datum4  				UNION ALL  				SELECT P.prIDX,P.ProduktString10,P.ProduktString11,PE.ProduktEinzelFloat1 AS Preis,PE.prIDX AS EinzelIDX,  				AM.prIDX AS AngebotIDX,AM.AngebotMainString17 AS AngebotText,AM.AngebotMainFloat1,AM.AngebotMainFloat2,AM.AngebotMainFloat3,AM.AngebotMainInt1,AM.AngebotMainInt3,  				AM.Datum3,AM.Datum4,  				'' AS AngebotString1,'' AS AngebotString2,'' AS AngebotString3,'' AS AngebotString4,  				0 AS AngebotInt2,0 AS AngebotInt3,0 AS AngebotInt4,  				0 AS AngebotFloat1,0 AS AngebotFloat2,0 AS AngebotFloat3,0 AS AngebotFloat4  				FROM laaver.Produkt AS P  				INNER JOIN laaver.Produkt_Einzel AS PE ON PE.frIDX = P.prIDX  				INNER JOIN laaver.Angebot_Main AS AM ON LOCATE(AM.AngebotMainString18, P.ProduktString14) > 0  				WHERE AM.AngebotMainInt3 = 3 AND AM.Status = 9 AND CURDATE() BETWEEN AM.Datum3 AND AM.Datum4  				UNION ALL  				SELECT P.prIDX,P.ProduktString10,P.ProduktString11,PE.ProduktEinzelFloat1 AS Preis,PE.prIDX AS EinzelIDX,  				AM.prIDX AS AngebotIDX,AM.AngebotMainString17 AS AngebotText,AM.AngebotMainFloat1,AM.AngebotMainFloat2,AM.AngebotMainFloat3,AM.AngebotMainInt1,AM.AngebotMainInt3,  				AM.Datum3,AM.Datum4,  				'' AS AngebotString1,'' AS AngebotString2,'' AS AngebotString3,'' AS AngebotString4,  				0 AS AngebotInt2,0 AS AngebotInt3,0 AS AngebotInt4,  				0 AS AngebotFloat1,0 AS AngebotFloat2,0 AS AngebotFloat3,0 AS AngebotFloat4  				FROM laaver.Produkt AS P  				INNER JOIN laaver.Produkt_Einzel AS PE ON PE.frIDX = P.prIDX  				INNER JOIN laaver.Angebot_Main AS AM ON LOCATE(AM.AngebotMainString19, P.ProduktString14) > 0  				WHERE AM.AngebotMainInt3 = 4 AND AM.Status = 9 AND CURDATE() BETWEEN AM.Datum3 AND AM.Datum4  				UNION ALL  				SELECT P.prIDX,P.ProduktString10,P.ProduktString11,PE.ProduktEinzelFloat1 AS Preis,PE.prIDX AS EinzelIDX,  				AM.prIDX AS AngebotIDX,AM.AngebotMainString17 AS AngebotText,AM.AngebotMainFloat1,AM.AngebotMainFloat2,AM.AngebotMainFloat3,AM.AngebotMainInt1,AM.AngebotMainInt3,  				AM.Datum3,AM.Datum4,  				'' AS AngebotString1,'' AS AngebotString2,'' AS AngebotString3,'' AS AngebotString4,  				0 AS AngebotInt2,0 AS AngebotInt3,0 AS AngebotInt4,  				0 AS AngebotFloat1,0 AS AngebotFloat2,0 AS AngebotFloat3,0 AS AngebotFloat4  				FROM laaver.Produkt AS P  				INNER JOIN laaver.Produkt_Einzel AS PE ON PE.frIDX = P.prIDX  				INNER JOIN laaver.Angebot_Main AS AM  				ON LOCATE(CONCAT('%2C', P.prIDX, '%2C'), CONCAT('%2C', AM.AngebotMainString22, '%2C')) > 0  				WHERE AM.AngebotMainInt3 = 6 AND AM.Status = 9 AND CURDATE() BETWEEN AM.Datum3 AND AM.Datum4  				ORDER BY prIDX;`;            con.query(sql, function (error, results) {        if (error) {            console.error('ProduktEinzelAngebot SQL Error:', error);            return res.status(500).send('SQL Error');        }        for (var i = 0; i < results.length; i++) {            var r = results[i];            AngebotArr.push(new AngebotObj(                r.prIDX,                r.ProduktString10,                r.ProduktString11,                r.AngebotText,                r.Datum3,                r.Datum4,                r.AngebotIDX,                r.Preis,                r.AngebotMainFloat1,                r.AngebotMainFloat2,                r.AngebotMainFloat3,                r.AngebotMainInt1,                r.AngebotMainInt3,                r.AngebotString1,                r.AngebotString2,                r.AngebotString3,                r.AngebotString4,                r.EinzelIDX,                r.AngebotInt2,                r.AngebotInt3,                r.AngebotInt4,                r.AngebotFloat1,                r.AngebotFloat2,                r.AngebotFloat3,                r.AngebotFloat4            ));        }        updateProduktEinzelAngebot(AngebotArr,res);    });});function updateProduktEinzelAngebot(AngebotArr,res){	var updateArr = new Array();	for(var i=0; i<AngebotArr.length; i++){		if(AngebotArr[i].EinzelIDX>0 && AngebotArr[i].AngebotMainFloat2>0 && AngebotArr[i].Preis>0){			updateArr.push([AngebotArr[i].prIDX,							AngebotArr[i].Preis,							AngebotArr[i].AngebotMainFloat2,						    parseFloat(parseFloat(AngebotArr[i].Preis*parseFloat(1-parseFloat(parseFloat(AngebotArr[i].AngebotMainFloat2)/100))).toFixed(2)),						    AngebotArr[i].EinzelIDX						  ]);		}	}	var txt = "";	txt += "UPDATE `laaver`.Produkt_Einzel SET ProduktEinzelInt2=0,ProduktEinzelFloat2=0; "; //首先删除所有产品的特价以及折扣	txt += "UPDATE `laaver`.Produkt SET ProduktInt10=0,ProduktBIT4=0; "; //删除产品特价标记	for(var i=0; i<updateArr.length; i++){		txt += "UPDATE `laaver`.Produkt_Einzel SET ProduktEinzelInt2="+updateArr[i][2]+",ProduktEinzelFloat2="+updateArr[i][3]+" WHERE prIDX="+updateArr[i][4]+"; ";		txt += "UPDATE `laaver`.Produkt SET ProduktInt10="+updateArr[i][2]+",ProduktBIT4=1 WHERE prIDX="+updateArr[i][0]+"; ";	}		//更新所有产品的特价		con.query(txt, (error) => {		if (error) throw error;		else{			//console.log("Produkt Preis update completed!");			res.end();		}	});}function compare(p){    return function(m,n){        var a = m[p];        var b = n[p];        return a - b; //升序    }}function AngebotObj(prIDX,ProduktString10,ProduktString11,AngebotText,Datum3,Datum4,AngebotIDX,Preis,AngebotMainFloat1,AngebotMainFloat2,AngebotMainFloat3,AngebotMainInt1,AngebotMainInt3,AngebotString1,AngebotString2,AngebotString3,AngebotString4,EinzelIDX,AngebotInt2,AngebotInt3,AngebotInt4,AngebotFloat1,AngebotFloat2,AngebotFloat3,AngebotFloat4){   this.prIDX=prIDX;   this.ProduktString10=ProduktString10;   this.ProduktString11=ProduktString11;   this.AngebotText=AngebotText;   this.Datum3=Datum3;   this.Datum4=Datum4;   this.AngebotIDX=AngebotIDX;   this.Preis=Preis;   this.AngebotMainFloat1=AngebotMainFloat1;   this.AngebotMainFloat2=AngebotMainFloat2;   this.AngebotMainFloat3=AngebotMainFloat3;   this.AngebotMainInt1=AngebotMainInt1;   this.AngebotMainInt3=AngebotMainInt3;   this.AngebotString1=AngebotString1;   this.AngebotString2=AngebotString2;   this.AngebotString3=AngebotString3;   this.AngebotString4=AngebotString4;   this.EinzelIDX=EinzelIDX;   this.AngebotInt2=AngebotInt2;   this.AngebotInt3=AngebotInt3;   this.AngebotInt4=AngebotInt4;   this.AngebotFloat1=AngebotFloat1;   this.AngebotFloat2=AngebotFloat2;   this.AngebotFloat3=AngebotFloat3;   this.AngebotFloat4=AngebotFloat4;}/**** Angebot Syn End ****/app.listen(process.env.PORT);